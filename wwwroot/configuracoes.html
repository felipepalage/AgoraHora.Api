<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configurações - AgoraHora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --brand-navy: #0a1933;
            --brand-teal: #0da5a0;
            --brand-teal-hover: #098581;
            --brand-teal-soft: #e6f9f8;
            --brand-purple: #6366f1;
            --bg: #f8fafc;
            --card: #ffffff;
            --muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --radius-lg: 20px;
            --radius-md: 14px;
            --radius-sm: 8px;
            --shadow-soft: 0 4px 15px rgba(10,25,51,.05);
            --shadow-medium: 0 10px 25px rgba(10,25,51,.08);
            --shadow-strong: 0 20px 40px rgba(10,25,51,.12);
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #334155; font: 500 15px/1.45 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        header { background: rgba(255,255,255,.9); border-bottom: 1px solid rgba(226,232,240,.6); position: sticky; top: 0; z-index: 10; backdrop-filter: blur(16px); box-shadow: var(--shadow-soft); }
        .top { max-width: 900px; margin: auto; padding: 14px 20px; display: flex; align-items: center; gap: 14px; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: 12px; cursor: pointer; transition: transform 0.2s ease; }
        .brand:hover { transform: scale(1.02); }
        .brand-icon { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--brand-teal), var(--brand-purple)); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(13,165,160,.25); }
        .brand-icon i { color: white; font-size: 20px; }
        .brand .name { font-weight: 800; font-size: 22px; color: var(--brand-navy); }
        .btn { padding: 10px 16px; border: none; border-radius: var(--radius-sm); background: linear-gradient(135deg, var(--brand-teal), var(--brand-teal-hover)); color: #fff; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s ease; position: relative; overflow: hidden; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255,255,255,0.2); transition: left 0.3s ease; }
        .btn:hover::before { left: 100%; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13,165,160,.35); }
        .btn[disabled] { opacity: .6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(10,25,51,.05); color: var(--brand-navy); }
        .btn-secondary:hover { background: rgba(10,25,51,.1); transform: translateY(-2px); }
        .btn-danger { background: var(--danger); box-shadow: 0 4px 15px rgba(239,68,68,.25); }
        .btn-danger:hover { background: var(--danger-dark); transform: translateY(-2px); }
        .container { max-width: 900px; margin: 24px auto; padding: 0 20px; }
        .card { background: var(--card); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-medium); border: 1px solid rgba(226,232,240,.6); transition: all 0.3s ease; }
        .card:hover { box-shadow: var(--shadow-strong); }
        h2 { margin-top: 0; color: var(--brand-navy); font-size: 24px; display: flex; align-items: center; gap: 10px; }
        h2 i { color: var(--brand-teal); }
        label { display: block; margin: 12px 0 6px; color: var(--brand-navy); font-weight: 600; display: flex; align-items: center; gap: 6px; }
        label i { color: var(--brand-teal); font-size: 14px; }
        input, textarea, select { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-md); outline: none; background: #f8fafc; font-size: 14px; transition: all 0.2s ease; }
        input:focus, textarea:focus, select:focus { background: #ffffff; border-color: var(--brand-teal); box-shadow: 0 0 0 3px rgba(13,165,160,.15); }
        textarea { min-height: 100px; resize: vertical; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media(max-width:700px) { .row { grid-template-columns: 1fr; } }
        .logo-wrap { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
        .logo-img { max-width: 220px; max-height: 150px; border-radius: var(--radius-md); background: #f1f5f9; object-fit: contain; border: 1px solid var(--border); box-shadow: var(--shadow-soft); transition: all 0.3s ease; }
        .logo-img:hover { transform: scale(1.02); box-shadow: var(--shadow-medium); }
        .ok, .err { margin-top: 12px; padding: 12px 16px; border-radius: var(--radius-md); font-weight: 600; display: flex; align-items: center; gap: 8px; animation: fadeIn 0.3s ease; display: none; }
        .ok { background: var(--brand-teal-soft); border: 1px solid var(--brand-teal); color: var(--brand-navy); }
        .ok i { color: var(--success); }
        .err { background: #fee2e2; border: 1px solid #fca5a5; color: var(--danger); }
        .err i { color: var(--danger); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-line { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 16px 0; padding: 16px; background: #f8fafc; border-radius: var(--radius-md); border: 1px solid var(--border); }
        .pill { background: var(--brand-teal-soft); color: var(--brand-navy); padding: 8px 16px; border-radius: 999px; font-weight: 700; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .pill i { color: var(--brand-teal); }
        .actions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: flex-end; margin-top: 20px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-label { padding: 10px 16px; border-radius: var(--radius-sm); background: rgba(10,25,51,.05); color: var(--brand-navy); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s ease; }
        .file-input-label:hover { background: rgba(10,25,51,.1); transform: translateY(-2px); }
        .section-title { font-size: 18px; font-weight: 700; color: var(--brand-navy); margin: 24px 0 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
        .section-title i { color: var(--brand-teal); }
    </style>
</head>
<body>
    <header>
        <div class="top">
            <div class="brand" aria-label="AgoraHora">
                <div class="brand-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="name">AgoraHora</div>
            </div>
            <button class="btn" id="logout">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2><i class="fas fa-store"></i> Dados do Estabelecimento</h2>
            
            <div class="section-title"><i class="fas fa-image"></i> Identidade Visual</div>
            <label for="logo">Logo do estabelecimento</label>
            <div class="logo-wrap">
                <div class="file-input-wrapper">
                    <input id="logo" type="file" accept="image/*">
                    <label for="logo" class="file-input-label">
                        <i class="fas fa-upload"></i> Escolher arquivo
                    </label>
                </div>
                <button type="button" id="removerLogo" class="btn btn-secondary">
                    <i class="fas fa-trash"></i> Remover logo
                </button>
            </div>
            <img id="logoPreview" class="logo-img" alt="Pré-visualização da logo" />

            <div class="section-title"><i class="fas fa-info-circle"></i> Informações Básicas</div>
            <div class="row">
                <div>
                    <label for="nome"><i class="fas fa-tag"></i> Nome</label>
                    <input id="nome" placeholder="Ex.: Barbearia Estilo">
                </div>
                <div>
                    <label for="telefone"><i class="fas fa-phone"></i> Telefone/WhatsApp</label>
                    <input id="telefone" placeholder="(11) 99999-9999">
                </div>
            </div>
            <label for="endereco"><i class="fas fa-map-marker-alt"></i> Endereço</label>
            <input id="endereco" placeholder="Rua, número, bairro, cidade">

            <div class="section-title"><i class="fas fa-clock"></i> Horários de Funcionamento</div>
            <label for="horarios"><i class="fas fa-calendar-alt"></i> Horários (descrição)</label>
            <textarea id="horarios" placeholder="Seg-Sex 09:00-19:00, Sáb 09:00-14:00"></textarea>
            <div class="row">
                <div>
                    <label for="abre"><i class="fas fa-door-open"></i> Abre às</label>
                    <input id="abre" type="time" step="60">
                </div>
                <div>
                    <label for="fecha"><i class="fas fa-door-closed"></i> Fecha às</label>
                    <input id="fecha" type="time" step="60">
                </div>
            </div>

            <div class="section-title"><i class="fas fa-align-left"></i> Descrição</div>
            <label for="descricao"><i class="fas fa-comment-alt"></i> Descrição</label>
            <textarea id="descricao" placeholder="Fale um pouco sobre a barbearia"></textarea>

            <div class="status-line">
                <span class="pill" id="ativoLabel">
                    <i class="fas fa-info-circle"></i>
                    Status: —
                </span>
                <button class="btn" id="btn-toggle-ativo">
                    <i class="fas fa-power-off"></i>
                    Abrir/Fechar agora
                </button>
            </div>

            <div class="actions">
                <button class="btn-secondary btn" id="btn-recarregar">
                    <i class="fas fa-sync-alt"></i> Recarregar
                </button>
                <button class="btn" id="btn-salvar">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>

            <div id="ok" class="ok">
                <i class="fas fa-check-circle"></i>
                <span>Configurações salvas!</span>
            </div>
            <div id="err" class="err">
                <i class="fas fa-exclamation-circle"></i>
                <span>Falha ao salvar.</span>
            </div>
        </div>
    </main>

   <script>
/* Configurações - script compatível com:
   GET  /api/configuracao/{estabelecimentoId}
   PUT  /api/configuracao/{estabelecimentoId}
   (não requer endpoints extras)
*/

const API_BASE = 'http://179.0.176.111:5000/api';
const $ = id => document.getElementById(id);

let estabId = null;
const logoKey = id => `logo_estab_${id}`;

/* UI elems */
const okEl = $('ok'), errEl = $('err'), btnSalvar = $('btn-salvar'), btnToggle = $('btn-toggle-ativo');
const preview = $('logoPreview');

function showOk(msg){ okEl.querySelector('span').textContent = msg; okEl.style.display='flex'; setTimeout(()=>okEl.style.display='none',3000); }
function showErr(msg){ errEl.querySelector('span').textContent = msg; errEl.style.display='flex'; setTimeout(()=>errEl.style.display='none',3000); }
function hideMsgs(){ okEl.style.display='none'; errEl.style.display='none'; }

function pad2(n){ return String(n).padStart(2,'0'); }
function minToHHmm(m){ if (m==null || Number.isNaN(Number(m))) return ''; return `${pad2(Math.floor(m/60))}:${pad2(m%60)}`; }
function HHmmToMin(hhmm){ if(!hhmm) return null; const [h,m]=hhmm.split(':').map(Number); if(Number.isNaN(h)||Number.isNaN(m)) return null; return h*60+m; }

let estadoAtivo = true;
function setAtivoLabel(ativo){
    estadoAtivo = !!ativo;
    const labelEl = $('ativoLabel');
    if(estadoAtivo){
        labelEl.innerHTML='<i class="fas fa-check-circle"></i> Status: Ativo (recebendo agendamentos)';
        btnToggle.innerHTML='<i class="fas fa-times-circle"></i> Fechar agora';
        btnToggle.className='btn btn-danger';
    } else {
        labelEl.innerHTML='<i class="fas fa-times-circle"></i> Status: Inativo';
        btnToggle.innerHTML='<i class="fas fa-check-circle"></i> Abrir agora';
        btnToggle.className='btn';
    }
}

/* fetch simple with timeout */
async function fetchWithTimeout(url, opts = {}, timeout = 12000){
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort(), timeout);
    try {
        const res = await fetch(url, { signal: controller.signal, ...opts });
        clearTimeout(id);
        return res;
    } catch (e) {
        clearTimeout(id);
        throw e;
    }
}

/* resolve estabId: url param ?estab=.. or localStorage ah_estab or /usuarios/me endpoints (requires token) */
async function resolveEstabId(){
    // 1) from querystring
    const q = new URLSearchParams(location.search);
    const qEst = q.get('estab');
    if (qEst && Number(qEst)) return Number(qEst);

    // 2) localStorage
    const ls = localStorage.getItem('ah_estab') || localStorage.getItem('ah_estabelecimentoId');
    if (ls && Number(ls)) return Number(ls);

    // 3) if token present, try /usuarios/me/estabelecimentos or /usuarios/me
    const token = localStorage.getItem('ah_token');
    if (!token) return null;
    const headers = { 'Authorization': 'Bearer ' + token, 'Accept': 'application/json' };

    try {
        const r = await fetchWithTimeout(`${API_BASE.replace(/\/$/,'')}/usuarios/me/estabelecimentos`, { headers, cache:'no-store' }, 8000);
        if (r.ok) {
            const arr = await r.json();
            if (Array.isArray(arr) && arr.length) return arr[0].estabelecimentoId ?? arr[0].EstabelecimentoId ?? null;
        }
    } catch (e) { console.warn('me/estabs failed', e); }

    try {
        const r2 = await fetchWithTimeout(`${API_BASE.replace(/\/$/,'')}/usuarios/me`, { headers, cache:'no-store' }, 8000);
        if (r2.ok) {
            const me = await r2.json();
            return me?.estabelecimentoId ?? me?.estabId ?? null;
        }
    } catch (e) { console.warn('usuarios/me failed', e); }

    return null;
}

/* carregar configuração usando somente as rotas que existem (GET /api/configuracao/{id}) */
async function loadConfiguracao(){
    hideMsgs();

    estabId = await resolveEstabId();
    if (!estabId){
        showErr('Estabelecimento não definido. Faça login novamente.');
        localStorage.removeItem('ah_token');
        return;
    }

    // carregar logo local (localStorage)
    const logoData = localStorage.getItem(logoKey(estabId));
    if (logoData) preview.src = logoData;

    // chamar GET /api/configuracao/{id}
    try {
        const url = `${API_BASE.replace(/\/$/,'')}/configuracao/${encodeURIComponent(estabId)}?_ts=${Date.now()}`;
        const r = await fetchWithTimeout(url, { cache:'no-store' }, 10000);

        if (r.status === 401) { localStorage.removeItem('ah_token'); location.href='login.html'; return; }
        if (r.status === 404) {
            // backend não expôs /configuracao/{id}
            showErr('Rota /api/configuracao/{id} não encontrada no backend. Preencha manualmente; salvar tentará criar/atualizar via PUT.');
            // limpa campos para edição manual
            $('nome').value = '';
            $('endereco').value = '';
            $('telefone').value = '';
            $('horarios').value = '';
            $('descricao').value = '';
            $('abre').value = '';
            $('fecha').value = '';
            setAtivoLabel(true);
            return;
        }

        if (!r.ok) {
            const t = await r.text().catch(()=>r.statusText);
            throw new Error(t || `HTTP ${r.status}`);
        }

        const j = await r.json();
        const cfg = j?.data?.configuracao ?? j?.configuracao ?? j?.data ?? j;
        const est = j?.data?.estabelecimento ?? j?.estabelecimento ?? null;

        // preenche campos
        $('nome').value = est?.Nome ?? est?.nome ?? (cfg?.NomeEstabelecimento ?? '') ;
        $('endereco').value = cfg?.Endereco ?? est?.Endereco ?? est?.endereco ?? '';
        $('telefone').value = cfg?.Telefone ?? '';
        $('horarios').value = cfg?.Horarios ?? '';
        $('descricao').value = cfg?.Descricao ?? '';
        $('abre').value = minToHHmm(Number(est?.AbreMin ?? cfg?.AbreMin ?? est?.abreMin ?? cfg?.abreMin ?? null));
        $('fecha').value = minToHHmm(Number(est?.FechaMin ?? cfg?.FechaMin ?? est?.fechaMin ?? cfg?.fechaMin ?? null));
        setAtivoLabel(Boolean(est?.Ativo ?? cfg?.Ativo ?? true));
    } catch (e) {
        console.error('loadConfiguracao error', e);
        if (e.name === 'AbortError') showErr('Timeout ao carregar configuração.');
        else showErr('Erro ao carregar configuração: ' + (e.message || e));
    }
}

/* salvar via PUT /api/configuracao/{id} (upsert no backend conforme seu controller) */
async function salvarConfiguracao(){
    hideMsgs();
    if (!estabId){ showErr('Estabelecimento indefinido.'); return; }

    const payload = {
        Telefone: $('telefone').value || null,
        Endereco: $('endereco').value || null,
        Horarios: $('horarios').value || null,
        Descricao: $('descricao').value || null,
        NomeEstabelecimento: $('nome').value || null,
        ImagemUrl: null, // deixamos imagem por localStorage; backend não aceita envio de arquivo aqui
        AbreMin: HHmmToMin($('abre').value),
        FechaMin: HHmmToMin($('fecha').value),
        Ativo: estadoAtivo
    };

    try {
        const url = `${API_BASE.replace(/\/$/,'')}/configuracao/${encodeURIComponent(estabId)}`;
        const r = await fetchWithTimeout(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }, 10000);

        if (r.status === 401) { localStorage.removeItem('ah_token'); location.href='login.html'; return; }
        if (r.status === 404) {
            showErr('PUT /api/configuracao/{id} não disponível no backend (404).');
            return;
        }
        if (!r.ok) {
            const t = await r.text().catch(()=>r.statusText);
            throw new Error(t || `HTTP ${r.status}`);
        }

        const j = await r.json().catch(()=>null);
        showOk('Configurações salvas!');
        // salvar logo localmente (persistência no front)
        const logoData = preview.src;
        if (logoData && logoData.startsWith('data:')) localStorage.setItem(logoKey(estabId), logoData);
    } catch (e) {
        console.error('salvarConfiguracao error', e);
        if (e.name === 'AbortError') showErr('Timeout ao salvar configuração.');
        else showErr('Falha ao salvar: ' + (e.message || e));
    }
}

/* handler para botão toggle: atualiza estado local e salva via PUT (o backend atualiza Estabelecimento/Ativo no PUT) */
async function toggleAtivo(){
    estadoAtivo = !estadoAtivo;
    setAtivoLabel(estadoAtivo);
    // salva alteração no servidor via PUT reutilizando campos atuais
    await salvarConfiguracao();
}

/* logo preview only: grava apenas em localStorage (backend não tem rota de logo) */
$('logo').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        preview.src = reader.result;
        if (estabId && preview.src && preview.src.startsWith('data:')) localStorage.setItem(logoKey(estabId), preview.src);
        showOk('Logo atualizada localmente (localStorage). Backend não suporta upload por essa rota.');
    };
    reader.readAsDataURL(file);
});

$('removerLogo').onclick = () => {
    preview.src = '';
    if (estabId) localStorage.removeItem(logoKey(estabId));
    showOk('Logo removida localmente.');
};

btnSalvar.onclick = salvarConfiguracao;
btnToggle.onclick = toggleAtivo;
$('btn-recarregar').onclick = loadConfiguracao;
$('logout').onclick = () => { location.href = 'index.html'; };

/* start */
loadConfiguracao();
</script>

</body>
</html>
