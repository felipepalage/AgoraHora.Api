<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configurações - AgoraHora</title>
    <style>
        :root {
            --brand-navy: #0f2b5c;
            --brand-teal: #19b7a6;
            --brand-teal-hover: #139987;
            --bg: #f5f7fa;
            --card: #fff;
            --muted: #8a94a6
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #1c2430;
            font: 500 15px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif
        }

        header {
            background: #fff;
            border-bottom: 1px solid #e9eef5;
            position: sticky;
            top: 0;
            z-index: 10
        }

        .top {
            max-width: 800px;
            margin: auto;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            justify-content: space-between
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px
        }

            .brand svg {
                width: 34px;
                height: 34px
            }

            .brand .name {
                font-weight: 800;
                font-size: 20px;
                color: var(--brand-navy)
            }

        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            background: var(--brand-teal);
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

            .btn:hover {
                background: var(--brand-teal-hover)
            }

            .btn[disabled] {
                opacity: .6;
                cursor: not-allowed
            }

        .btn-secondary {
            background: #e9eef5;
            color: #1c2430
        }

        .btn-danger {
            background: #e35151
        }

            .btn-danger:hover {
                background: #c63838
            }

        .container {
            max-width: 800px;
            margin: 24px auto;
            padding: 0 20px
        }

        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 16px 40px rgba(15,43,92,.06),0 4px 12px rgba(15,43,92,.05)
        }

        label {
            display: block;
            margin: 8px 0 6px;
            color: var(--brand-navy);
            font-weight: 700
        }

        input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e3e8ef;
            border-radius: 10px;
            outline: none
        }

        textarea {
            min-height: 90px;
            resize: vertical
        }

            input:focus, textarea:focus {
                box-shadow: 0 0 0 4px rgba(25,183,166,.12)
            }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        @media(max-width:700px) {
            .row {
                grid-template-columns: 1fr
            }
        }

        .logo-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap
        }

        .logo-img {
            max-width: 220px;
            border-radius: 12px;
            background: #eef2f7
        }

        .ok {
            margin-top: 8px;
            padding: 10px;
            border-radius: 10px;
            background: #e7f7f5;
            border: 1px solid #caefe8;
            color: #0f6d64;
            font-weight: 700;
            display: none
        }

        .err {
            margin-top: 8px;
            padding: 10px;
            border-radius: 10px;
            background: #ffeaea;
            border: 1px solid #ffcccc;
            color: #b91c1c;
            font-weight: 700;
            display: none
        }

        .status-line {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 10px 0
        }

        .pill {
            background: #e7f7f5;
            color: #0f6d64;
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 800
        }
    </style>
</head>
<body>
    <header>
        <div class="top">
            <div class="brand" aria-label="AgoraHora">
                <svg viewBox="0 0 64 64" aria-hidden="true"><circle cx="32" cy="32" r="28" fill="none" stroke="#19b7a6" stroke-width="6" /><path d="M20 33.5l7 7 17-17" fill="none" stroke="#19b7a6" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" /></svg>
                <div class="name">AgoraHora</div>
            </div>
            <button class="btn" id="logout">Voltar</button>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2 style="margin-top:0;color:var(--brand-navy)">Dados do Estabelecimento</h2>

            <!-- Logo salva no navegador -->
            <label for="logo">Logo do estabelecimento</label>
            <div class="logo-wrap">
                <input id="logo" type="file" accept="image/*">
                <button type="button" id="removerLogo" class="btn btn-secondary">Remover logo</button>
            </div>
            <img id="logoPreview" class="logo-img" alt="Pré-visualização da logo" />

            <div class="row" style="margin-top:12px">
                <div>
                    <label for="nome">Nome</label>
                    <input id="nome" placeholder="Ex.: Barbearia Estilo">
                </div>
                <div>
                    <label for="telefone">Telefone/WhatsApp</label>
                    <input id="telefone" placeholder="(11) 99999-9999">
                </div>
            </div>

            <label for="endereco">Endereço</label>
            <input id="endereco" placeholder="Rua, número, bairro, cidade">

            <label for="horarios">Horários (descrição)</label>
            <textarea id="horarios" placeholder="Seg-Sex 09:00-19:00, Sáb 09:00-14:00"></textarea>

            <div class="row">
                <div>
                    <label for="abre">Abre às</label>
                    <input id="abre" type="time" step="60">
                </div>
                <div>
                    <label for="fecha">Fecha às</label>
                    <input id="fecha" type="time" step="60">
                </div>
            </div>

            <label for="descricao">Descrição</label>
            <textarea id="descricao" placeholder="Fale um pouco sobre a barbearia"></textarea>

            <div class="status-line">
                <span class="pill" id="ativoLabel">Status: —</span>
                <button class="btn" id="btn-toggle-ativo">Abrir/Fechar agora</button>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn-secondary btn" id="btn-recarregar">Recarregar</button>
                <button class="btn" id="btn-salvar">Salvar</button>
            </div>

            <div id="ok" class="ok">Configurações salvas!</div>
            <div id="err" class="err">Falha ao salvar.</div>
        </div>
    </main>

    <script>
        // ===== CONFIG =====
        const API_BASE = '/api';
        const estabId = Number(new URLSearchParams(location.search).get('estab') || 1);

        // UI
        const $ = id => document.getElementById(id);
        $('logout').onclick = () => { location.href = 'index.html'; };
        const okEl = $('ok'), errEl = $('err'), btnSalvar = $('btn-salvar'), btnToggle = $('btn-toggle-ativo');

        // storage keys
        const logoKey = id => `logo_estab_${id}`;
        const estabUpdatedKey = id => `estab_${id}_updated`;

        // utils
        const pad2 = n => String(n).padStart(2, '0');
        const minToHHmm = m => `${pad2(Math.floor(m / 60))}:${pad2(m % 60)}`;
        const HHmmToMin = hhmm => {
            if (!hhmm) return null;
            const [h, m] = hhmm.split(':').map(Number);
            if (Number.isNaN(h) || Number.isNaN(m)) return null;
            return h * 60 + m;
        };

        function normalizeImageUrl(u) {
            const fallback = '';
            try {
                if (!u) return fallback;
                u = String(u).trim();
                if (u.startsWith('//')) return location.protocol + u;
                if (/^https?:/i.test(u)) {
                    const url = new URL(u);
                    url.pathname = url.pathname.split('/').map(encodeURIComponent).join('/');
                    return url.toString();
                }
                return u;
            } catch { return fallback; }
        }

        function showOk(msg) { okEl.textContent = msg; okEl.style.display = 'block'; setTimeout(() => okEl.style.display = 'none', 1800); }
        function showErr(msg) { errEl.textContent = msg; errEl.style.display = 'block'; }
        function hideMsgs() { okEl.style.display = 'none'; errEl.style.display = 'none'; }

        function setAtivoLabel(ativo) {
            $('ativoLabel').textContent = `Status: ${ativo ? 'Ativo (recebendo agendamentos)' : 'Inativo'}`;
            btnToggle.textContent = ativo ? 'Fechar agora' : 'Abrir agora';
            btnToggle.className = ativo ? 'btn btn-danger' : 'btn';
        }

        // ===== LOAD =====
        let estadoAtivo = true;
        async function load() {
            hideMsgs();
            try {
                // GET Config + Estabelecimento agregado
                const r = await fetch(`${API_BASE}/configuracao/${estabId}?_ts=${Date.now()}`, { cache: 'no-store' });
                if (r.ok) {
                    const j = await r.json();
                    const cfg = j?.data?.configuracao || {};
                    const est = j?.data?.estabelecimento || {};

                    // campos texto
                    $('nome').value = est?.nome ?? '';
                    $('endereco').value = est?.endereco ?? cfg?.endereco ?? '';
                    $('telefone').value = cfg?.telefone ?? '';
                    $('horarios').value = cfg?.horarios ?? '';
                    $('descricao').value = cfg?.descricao ?? '';

                    // horários de funcionamento
                    const abreMin = Number(est?.abreMin ?? 540);
                    const fechaMin = Number(est?.fechaMin ?? 1080);
                    $('abre').value = minToHHmm(abreMin);
                    $('fecha').value = minToHHmm(fechaMin);

                    // status ativo
                    estadoAtivo = Boolean(est?.ativo ?? true);
                    setAtivoLabel(estadoAtivo);

                    // logo preview
                    const custom = localStorage.getItem(logoKey(estabId));
                    const fromApi = normalizeImageUrl(est?.imagemUrl);
                    $('logoPreview').src = custom || fromApi || '';
                } else {
                    // fallback: carregar só estabelecimento simples
                    const re = await fetch(`${API_BASE}/estabelecimentos/${estabId}?_ts=${Date.now()}`, { cache: 'no-store' });
                    if (re.ok) {
                        const je = await re.json(); const e = je?.data || je;
                        $('nome').value = e?.nome ?? '';
                        $('endereco').value = e?.endereco ?? '';
                        $('abre').value = minToHHmm(e?.abreMin ?? 540);
                        $('fecha').value = minToHHmm(e?.fechaMin ?? 1080);
                        estadoAtivo = Boolean(e?.ativo ?? true);
                        setAtivoLabel(estadoAtivo);
                        const custom = localStorage.getItem(logoKey(estabId));
                        const fromApi = normalizeImageUrl(e?.img || e?.imagemUrl);
                        $('logoPreview').src = custom || fromApi || '';
                    }
                }
            } catch { }
            const cached = localStorage.getItem(logoKey(estabId));
            if (cached) $('logoPreview').src = cached;
        }

        // ===== LOGO (localStorage) =====
        $('logo').addEventListener('change', async () => {
            const f = $('logo').files?.[0];
            if (!f) return;
            try {
                const dataURL = await new Promise((resolve, reject) => {
                    const img = new Image(), fr = new FileReader();
                    fr.onload = e => img.src = e.target.result;
                    fr.onerror = reject;
                    img.onload = () => {
                        const maxW = 960, quality = .85;
                        const scale = Math.min(1, maxW / img.width);
                        const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
                        const c = document.createElement('canvas'); c.width = w; c.height = h;
                        c.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(c.toDataURL('image/webp', quality));
                    };
                    img.onerror = reject;
                    fr.readAsDataURL(f);
                });
                localStorage.setItem(logoKey(estabId), dataURL);
                $('logoPreview').src = dataURL;
                localStorage.setItem(estabUpdatedKey(estabId), String(Date.now()));
            } catch { showErr('Falha ao processar a imagem.'); }
        });

        $('removerLogo').onclick = () => {
            localStorage.removeItem(logoKey(estabId));
            $('logoPreview').removeAttribute('src');
            localStorage.setItem(estabUpdatedKey(estabId), String(Date.now()));
        };

        // ===== TOGGLE ATIVO =====
        btnToggle.onclick = async () => {
            hideMsgs();
            btnToggle.disabled = true;
            const novoAtivo = !estadoAtivo;
            try {
                const body = { Ativo: novoAtivo };
                const r = await fetch(`${API_BASE}/configuracao/${estabId}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!r.ok) {
                    const j = await r.json().catch(() => ({}));
                    throw new Error(j.message || `HTTP ${r.status}`);
                }
                estadoAtivo = novoAtivo;
                setAtivoLabel(estadoAtivo);
                showOk(novoAtivo ? 'Estabelecimento aberto.' : 'Estabelecimento fechado.');
                localStorage.setItem(estabUpdatedKey(estabId), String(Date.now()));
            } catch (e) {
                showErr(e.message || 'Falha ao alterar status.');
            } finally {
                btnToggle.disabled = false;
            }
        };

        // ===== SALVAR TUDO =====
        $('btn-salvar').onclick = async () => {
            hideMsgs(); btnSalvar.disabled = true;

            const nome = $('nome').value.trim();
            const endereco = $('endereco').value.trim();
            const telefone = $('telefone').value.trim();
            const horarios = $('horarios').value.trim();
            const descricao = $('descricao').value.trim();
            const abreMin = HHmmToMin($('abre').value);
            const fechaMin = HHmmToMin($('fecha').value);

            if (abreMin == null || fechaMin == null) {
                showErr('Informe horários válidos.'); btnSalvar.disabled = false; return;
            }
            if (abreMin === fechaMin) {
                showErr('AbreMin não pode ser igual a FechaMin.'); btnSalvar.disabled = false; return;
            }

            const body = {
                Telefone: telefone || null,
                Endereco: endereco || null,
                Horarios: horarios || null,
                Descricao: descricao || null,
                NomeEstabelecimento: nome || null,
                // ImagemUrl intencionalmente não enviada. Logo é localStorage no cliente.
                AbreMin: abreMin,
                FechaMin: fechaMin,
                Ativo: estadoAtivo
            };

            try {
                const r = await fetch(`${API_BASE}/configuracao/${estabId}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!r.ok) {
                    const j = await r.json().catch(() => ({}));
                    throw new Error(j.message || `HTTP ${r.status}`);
                }
                showOk('Configurações salvas!');
                localStorage.setItem(estabUpdatedKey(estabId), String(Date.now()));
            } catch (e) {
                showErr(e.message || 'Falha ao salvar.');
            } finally {
                btnSalvar.disabled = false;
            }
        };

        $('btn-recarregar').onclick = load;

        // Auto-reload quando outra aba salvar algo
        window.addEventListener('storage', ev => {
            if (ev.key === logoKey(estabId)) {
                const v = localStorage.getItem(logoKey(estabId));
                if (v) $('logoPreview').src = v; else $('logoPreview').removeAttribute('src');
            }
            if (ev.key === estabUpdatedKey(estabId)) load();
        });

        load();
    </script>
</body>
</html>
