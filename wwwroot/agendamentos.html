<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendamentos - AgoraHora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{
            --brand-navy:#0a1933; --brand-teal:#0da5a0; --border:#e2e8f0; --card:#ffffff; --muted:#64748b;
            --danger:#ef4444; --radius-md:14px; --shadow-medium: 0 10px 25px rgba(10,25,51,.08);
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{font:500 15px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:linear-gradient(135deg,#f8fafc 0,#e2e8f0 100%);color:#334155}
        header{background:rgba(255,255,255,.9);border-bottom:1px solid rgba(226,232,240,.6);backdrop-filter:blur(16px);position:sticky;top:0;z-index:20}
        .top{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
        .brand{display:flex;gap:12px;align-items:center}
        .brand-icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand-teal),#6366f1);display:flex;align-items:center;justify-content:center;color:#fff}
        .btn{padding:10px 16px;border-radius:8px;border:0;background:linear-gradient(135deg,var(--brand-teal),#098581);color:#fff;cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center}
        .container{max-width:1200px;margin:24px auto;padding:0 20px}
        .page-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:24px}
        .filters{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:16px;margin-bottom:20px}
        @media(max-width:768px){.filters{grid-template-columns:1fr}}
        .field label{font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:6px}
        .field select,.field input{width:100%;padding:12px 16px;border-radius:var(--radius-md);border:1px solid var(--border);background:#f8fafc}
        .table-wrapper{overflow-x:auto;border-radius:var(--radius-md);border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow-medium)}
        table{width:100%;border-collapse:collapse}
        th,td{padding:14px 16px;border-bottom:1px solid var(--border);text-align:left}
        th{color:var(--brand-navy);font-size:13px;font-weight:700;text-transform:uppercase}
        .empty{padding:20px;text-align:center;color:var(--muted);font-style:italic}
        .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:8px;font-weight:600;text-transform:uppercase}
        .error-message{margin-top:16px;padding:12px 16px;border-radius:12px;background:#fee2e2;border-left:4px solid var(--danger);color:var(--danger);font-weight:600;display:none}
        .small-muted{font-size:13px;color:var(--muted)}
    </style>
</head>
<body>
    <header>
      <div class="top">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-calendar-check"></i></div>
            <div class="name">AgoraHora</div>
        </div>
        <button class="btn" id="voltar"><i class="fas fa-arrow-left"></i> Voltar</button>
      </div>
    </header>

    <main class="container">
        <div class="page-header">
            <h2><i class="fas fa-calendar-alt"></i> Agendamentos</h2>
            <div>
                <button class="btn" id="btn-hoje"><i class="fas fa-calendar-day"></i> Hoje</button>
            </div>
        </div>

        <div class="filters" role="region" aria-label="Filtros">
            <div class="field">
                <label><i class="fas fa-user-tie"></i> Profissional</label>
                <select id="profissional" aria-label="Profissional"></select>
                <div id="prof-help" class="small-muted" style="margin-top:6px">Selecione para ver agendamentos do dia.</div>
            </div>
            <div class="field">
                <label><i class="fas fa-calendar"></i> Data</label>
                <input type="date" id="filtro-data" aria-label="Data">
            </div>
            <div class="field">
                <label><i class="fas fa-info-circle"></i> Status</label>
                <select id="filtro-status" aria-label="Status">
                    <option value="">Todos</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Cancelado">Cancelado</option>
                    <option value="Concluido">Concluído</option>
                </select>
            </div>
            <div style="display:flex;align-items:end">
                <button class="btn" id="btn-filtrar"><i class="fas fa-search"></i> Filtrar</button>
            </div>
        </div>

        <div class="table-wrapper" id="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Serviço</th>
                        <th>Profissional</th>
                        <th>Data e horário</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <tr class="empty"><td colspan="5"><i class="fas fa-spinner fa-spin"></i> Carregando agendamentos…</td></tr>
                </tbody>
            </table>
        </div>

        <div id="erro" class="error-message"><i class="fas fa-exclamation-circle"></i> Não foi possível carregar os agendamentos.</div>
    </main>

<script>
/* ===========================
   CONFIGURAÇÃO GLOBAL
=========================== */
const API_BASE = window.API_BASE || "http://179.0.176.111:5000/api";
console.info("API_BASE =", API_BASE);

/* ===========================
   GUARD DE AUTENTICAÇÃO
   (só exige token; estab pode vir do backend)
=========================== */
(function authGuard() {
    const token = localStorage.getItem("ah_token");
    if (!token) {
        // se não houver token, volta para login
        window.location.href = "login.html";
        return;
    }
})();

/* ===========================
   ELEMENTOS
=========================== */
const selProf = document.getElementById("profissional");
const filtroData = document.getElementById("filtro-data");
const filtroStatus = document.getElementById("filtro-status");
const tbody = document.getElementById("tbody");
const erro = document.getElementById("erro");
const btnHoje = document.getElementById("btn-hoje");
const btnFiltrar = document.getElementById("btn-filtrar");
const profHelp = document.getElementById("prof-help");

document.getElementById("voltar").onclick = () => {
    if (document.referrer && document.referrer !== location.href) history.back();
    else window.location.href = "index.html";
};

/* ===========================
   UTILIDADES
=========================== */
function hojeIso(){ return new Date().toISOString().slice(0,10); }
filtroData.value = hojeIso();

btnHoje.onclick = () => { filtroData.value = hojeIso(); carregar(); };
btnFiltrar.onclick = carregar;
selProf.onchange = carregar;

function statusKey(status){
    if(!status) return "pendente";
    return String(status).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
}

function fmtData(dt){
    try{
        const d = new Date(dt);
        if(isNaN(d)) return String(dt);
        return d.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{ return String(dt); }
}

/* ===========================
   FETCH SEGURO
=========================== */
async function fetchWithTimeout(resource, options = {}) {
    const { timeout = 10000 } = options;
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    try {
        const res = await fetch(resource, { signal: controller.signal, ...options });
        clearTimeout(id);
        return res;
    } catch (err) {
        clearTimeout(id);
        throw err;
    }
}

async function getJson(url) {
    if (!/^https?:\/\//i.test(url)) {
        url = API_BASE.replace(/\/$/, '') + '/' + url.replace(/^\/+/, '');
    }

    const headers = { 'Accept': 'application/json' };
    const token = localStorage.getItem('ah_token');
    if (token) headers['Authorization'] = 'Bearer ' + token;

    try {
        const r = await fetchWithTimeout(url, { headers, cache: 'no-store', timeout: 12000 });
        const ct = r.headers.get('content-type') || '';

        if (!r.ok) {
            // trata 401: token inválido/expirado
            if (r.status === 401) {
                localStorage.removeItem('ah_token');
                localStorage.removeItem('ah_estab');
                window.location.href = 'login.html';
                throw new Error('Não autorizado (401)');
            }

            let bodyText = '';
            try {
                bodyText = ct.includes('json') ? JSON.stringify(await r.json()) : await r.text();
            } catch { bodyText = ''; }

            throw new Error(`HTTP ${r.status} - ${bodyText || r.statusText}`);
        }

        if (ct.includes('json')) return r.json();

        const txt = await r.text();
        try { return JSON.parse(txt); } catch { return txt; }

    } catch (err) {
        if (err.name === 'AbortError') throw new Error('Request timeout');
        throw err;
    }
}

/* ===========================
   RESOLVE ESTAB PELO LOGIN
   tenta /usuarios/me/estabelecimentos e /usuarios/me
=========================== */
async function resolveEstabId(){
    const token = localStorage.getItem('ah_token');
    if (!token) return null;
    const headers = { 'Accept': 'application/json', 'Authorization': 'Bearer ' + token };
    const base = API_BASE.replace(/\/$/, '');

    // 1) tentar /usuarios/me/estabelecimentos
    try {
        const r1 = await fetchWithTimeout(`${base}/usuarios/me/estabelecimentos`, { headers, cache:'no-store', timeout:8000 });
        if (r1.ok) {
            const data = await r1.json();
            if (Array.isArray(data) && data.length > 0) {
                return data[0].estabelecimentoId ?? data[0].EstabelecimentoId ?? null;
            }
        } else if (r1.status === 401) {
            localStorage.removeItem('ah_token');
            window.location.href = 'login.html';
            return null;
        }
    } catch (err) {
        console.warn('resolveEstabId: /usuarios/me/estabelecimentos failed:', err && err.message ? err.message : err);
    }

    // 2) tentar /usuarios/me
    try {
        const r2 = await fetchWithTimeout(`${base}/usuarios/me`, { headers, cache:'no-store', timeout:8000 });
        if (r2.ok) {
            const j = await r2.json();
            return j?.estabelecimentoId ?? j?.estabId ?? j?.estabelecimento?.id ?? null;
        } else if (r2.status === 401) {
            localStorage.removeItem('ah_token');
            window.location.href = 'login.html';
            return null;
        }
    } catch (err) {
        console.warn('resolveEstabId: /usuarios/me failed:', err && err.message ? err.message : err);
    }

    return null;
}


/* ===========================
   CARREGAR PROFISSIONAIS
=========================== */
async function carregarProfissionais() {
    selProf.innerHTML = `<option value="">Carregando...</option>`;

    try {
        const estabSaved = Number(localStorage.getItem("ah_estab")) || null;
        const estabResolved = await resolveEstabId();
        const finalEstab = estabSaved || estabResolved || 1;

        const url = `${API_BASE.replace(/\/$/, '')}/profissionais/${finalEstab}`;
        const js = await getJson(url);

        const profs = js?.data ?? js;

        if (!Array.isArray(profs) || !profs.length) {
            selProf.innerHTML = `<option value="">Nenhum profissional disponível</option>`;
            profHelp.textContent = 'Não existem profissionais cadastrados para este estabelecimento.';
            return;
        }

        selProf.innerHTML =
            `<option value="">-- Selecionar profissional --</option>` +
            profs.map(p => {
                const id =
                    p.id ?? p.Id ?? p.ID ?? p.ID_PROFISSIONAL ?? p.IdProfissional;
                const nome =
                    p.nome ?? p.Nome ?? p.NM_PROFISSIONAL ?? p.NomeProfissional ?? 'Sem nome';
                return `<option value="${id}">${nome}</option>`;
            }).join('');

        profHelp.textContent = '';
    } catch (e) {
        console.error("Erro carregar profissionais", e);
        selProf.innerHTML = `<option value="">Erro ao carregar</option>`;
        profHelp.textContent = 'Falha ao carregar profissionais. Verifique se a API está disponível e CORS/URL corretos.';
        throw e;
    }
}

/* ===========================
   RENDER TABELA
=========================== */
function escapeHtml(s){
    return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

function render(lista) {
    if (!lista || !lista.length) {
        tbody.innerHTML =
            `<tr class="empty"><td colspan="5">Nenhum agendamento encontrado.</td></tr>`;
        return;
    }

    tbody.innerHTML = lista.map(a => {
        const cliente = a.cliente ?? a.Cliente ?? a.NM_CLIENTE ?? "—";
        const servico = a.servico ?? a.Servico ?? a.NM_SERVICO ?? "—";
        const profissional = a.profissional ?? a.Profissional ?? a.NM_PROFISSIONAL ?? "—";
        const dtInicio = a.dtInicio ?? a.DtInicio ?? a.DT_AGENDAMENTO ?? null;
        const st = a.status ?? a.Status ?? "Pendente";
        const key = statusKey(st);

        return `
        <tr>
            <td>${escapeHtml(cliente)}</td>
            <td>${escapeHtml(servico)}</td>
            <td>${escapeHtml(profissional)}</td>
            <td>${escapeHtml(dtInicio ? fmtData(dtInicio) : "—")}</td>
            <td><span class="badge" data-status="${key}">${escapeHtml(st)}</span></td>
        </tr>`;
    }).join('');
}

/* ===========================
   CARREGAR AGENDAMENTOS
=========================== */
async function carregar(){
    erro.style.display = 'none';
    tbody.innerHTML =
        `<tr class="empty"><td colspan="5"><i class="fas fa-spinner fa-spin"></i> Carregando…</td></tr>`;

    const profId = selProf.value;
    if (!profId) {
        tbody.innerHTML =
            `<tr class="empty"><td colspan="5"><i class="fas fa-user-tie"></i> Selecione um profissional.</td></tr>`;
        return;
    }

    const dia = filtroData.value || hojeIso();
    const ini = `${dia}T00:00:00`;
    const fim = `${dia}T23:59:59`;

    let url =
        `${API_BASE.replace(/\/$/, '')}/agendamentos/profissional` +
        `?profissionalId=${encodeURIComponent(profId)}` +
        `&ini=${encodeURIComponent(ini)}` +
        `&fim=${encodeURIComponent(fim)}`;

    if (filtroStatus.value)
        url += `&status=${encodeURIComponent(filtroStatus.value)}`;

    try {
        const js = await getJson(url);
        const lista = js?.data ?? js;
        render(lista);
    } catch (e) {
        console.error("Erro carregar agendamentos", e);
        erro.style.display = 'flex';
        erro.innerHTML = `<i class="fas fa-exclamation-circle"></i> Erro ao carregar: ${escapeHtml(e.message || 'unknown')}`;
        tbody.innerHTML = `<tr class="empty"><td colspan="5"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar agendamentos. Veja detalhes acima.</td></tr>`;
    }
}

/* ===========================
   INIT
=========================== */
(async function init(){
    try {
        await carregarProfissionais();

        if (selProf.value)
            await carregar();

    } catch (e) {
        erro.style.display = 'flex';
        erro.innerHTML = `<i class="fas fa-exclamation-circle"></i> Falha na inicialização: ${escapeHtml(e.message || 'Ver console')}`;
    }
})();
</script>

</body>
</html>
