<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendamentos - AgoraHora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ================== TEMA CLARO CONSISTENTE ================== */
        :root {
            --brand-navy: #0a1933;
            --brand-teal: #0da5a0;
            --brand-teal-hover: #098581;
            --brand-teal-soft: #e6f9f8;
            --brand-purple: #6366f1;
            --bg: #f8fafc;
            --card: #ffffff;
            --muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --success: #10b981;
            --info: #3b82f6;
            --radius-lg: 20px;
            --radius-md: 14px;
            --radius-sm: 8px;
            --shadow-soft: 0 4px 15px rgba(10,25,51,.05);
            --shadow-medium: 0 10px 25px rgba(10,25,51,.08);
            --shadow-strong: 0 20px 40px rgba(10,25,51,.12);
        }
        /* RESET */
        * { box-sizing: border-box; margin: 0; padding: 0 }
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #334155;
            font: 500 15px/1.45 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }
        header {
            background: rgba(255,255,255,.9);
            border-bottom: 1px solid rgba(226,232,240,.6);
            backdrop-filter: blur(16px);
            position: sticky; top: 0; z-index: 20;
        }
        .top { max-width: 1200px; margin: auto; padding: 14px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
        .brand { display:flex; align-items:center; gap:12px; cursor:pointer; transition: transform .2s ease; }
        .brand:hover { transform: scale(1.02); }
        .brand-icon { width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg,var(--brand-teal),var(--brand-purple)); display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(13,165,160,.25); }
        .brand-icon i { color:white; font-size:20px; }
        .brand .name { font-weight:800; font-size:20px; color:var(--brand-navy); }
        .btn { padding:10px 16px; border:none; border-radius:var(--radius-sm); background: linear-gradient(135deg,var(--brand-teal),var(--brand-teal-hover)); color:#fff; font-weight:600; cursor:pointer; box-shadow:0 4px 15px rgba(13,165,160,.25); transition:all .2s ease; display:inline-flex; align-items:center; gap:8px; position:relative; overflow:hidden; }
        .btn::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:rgba(255,255,255,.2); transition:left .3s ease; }
        .btn:hover::before { left:100%; } .btn:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(13,165,160,.35); }
        .btn-ghost { padding:8px 12px; border-radius:var(--radius-sm); border:1px solid var(--border); background:rgba(10,25,51,.05); color:var(--brand-navy); cursor:pointer; font-weight:600; transition:all .2s ease; display:inline-flex; align-items:center; gap:6px; }
        .btn-ghost:hover { background:rgba(10,25,51,.1); transform: translateY(-1px); }
        .container { max-width:1200px; margin:24px auto; padding:0 20px; }
        .page-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:24px; }
        .filters { display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:16px; margin-bottom:20px; }
        @media(max-width:768px){ .filters { grid-template-columns:1fr; } }
        .field label { font-weight:600; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
        .field label i { color:var(--brand-teal); }
        .field select, .field input { width:100%; padding:12px 16px; border-radius:var(--radius-md); border:1px solid var(--border); background:#f8fafc; color:#334155; outline:none; transition:all .2s ease; }
        .field select:focus, .field input:focus { background:#fff; border-color:var(--brand-teal); box-shadow:0 0 0 3px rgba(13,165,160,.15); }
        .table-wrapper { overflow-x:auto; border-radius:var(--radius-md); border:1px solid var(--border); background:var(--card); box-shadow:var(--shadow-medium); }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:14px 16px; border-bottom:1px solid var(--border); text-align:left; }
        th { color:var(--brand-navy); font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; background:#f8fafc; }
        tbody tr:hover { background:#f1f5f9; }
        .empty { text-align:center; padding:20px 0; color:var(--muted); font-style:italic; }
        .empty i { font-size:24px; margin-bottom:8px; display:block; color:var(--muted); }
        .badge { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:var(--radius-sm); font-size:12px; font-weight:600; text-transform:uppercase; }
        .badge[data-status="pendente"] { background:#fef3c7; color:#92400e; }
        .badge[data-status="confirmado"] { background:#d1fae5; color:#065f46; }
        .badge[data-status="cancelado"] { background:#fee2e2; color:#991b1b; }
        .badge[data-status="concluido"], .badge[data-status="concluído"] { background:#dbeafe; color:#1e40af; }
        .badge-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; }
        .badge[data-status="pendente"] .badge-dot { background:#f59e0b; }
        .badge[data-status="confirmado"] .badge-dot { background:#10b981; }
        .badge[data-status="cancelado"] .badge-dot { background:#ef4444; }
        .badge[data-status="concluido"] .badge-dot, .badge[data-status="concluído"] .badge-dot { background:#3b82f6; }
        .error-message { margin-top:16px; padding:12px 16px; border-radius:var(--radius-md); background:#fee2e2; border-left:4px solid var(--danger); color:var(--danger); font-weight:600; display:none; align-items:center; gap:8px; }
    </style>
</head>
<body>

    <header>
      <div class="top">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-calendar-check"></i></div>
            <div class="name">AgoraHora</div>
        </div>
        <button class="btn" id="voltar"><i class="fas fa-arrow-left"></i> Voltar</button>
      </div>
    </header>

    <main class="container">

        <div class="page-header">
            <h2><i class="fas fa-calendar-alt"></i> Agendamentos</h2>
            <div>
                <button class="btn" id="btn-hoje"><i class="fas fa-calendar-day"></i> Hoje</button>
            </div>
        </div>

        <div class="filters">
            <div class="field">
                <label><i class="fas fa-user-tie"></i> Profissional</label>
                <select id="profissional"></select>
            </div>
            <div class="field">
                <label><i class="fas fa-calendar"></i> Data</label>
                <input type="date" id="filtro-data">
            </div>
            <div class="field">
                <label><i class="fas fa-info-circle"></i> Status</label>
                <select id="filtro-status">
                    <option value="">Todos</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Cancelado">Cancelado</option>
                    <option value="Concluido">Concluído</option>
                </select>
            </div>
            <div>
                <button class="btn" id="btn-filtrar"><i class="fas fa-search"></i> Filtrar</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Serviço</th>
                        <th>Profissional</th>
                        <th>Data e horário</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <tr class="empty">
                        <td colspan="5"><i class="fas fa-spinner fa-spin"></i> Carregando agendamentos…</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="erro" class="error-message"><i class="fas fa-exclamation-circle"></i> Não foi possível carregar os agendamentos.</div>

    </main>

<script>
/* ========== CONFIGURAÇÃO (defina seu endpoint da VM aqui) ========== */
const API_BASE = "http://179.0.176.111:5000/api";

/* ========== HELPERS DE URL e FETCH ========== */
function fullApi(pathOrUrl) {
    if (!pathOrUrl) return API_BASE;
    try {
        // se já for URL absoluta
        const u = new URL(pathOrUrl);
        return u.toString();
    } catch { /* não absoluta */ }
    return API_BASE.replace(/\/+$/, '') + '/' + String(pathOrUrl).replace(/^\/+/, '');
}

async function getJson(pathOrUrl, opts = {}) {
    const url = fullApi(pathOrUrl);
    const headers = Object.assign({}, opts.headers || {});
    headers['Accept'] = headers['Accept'] || 'application/json';
    const token = localStorage.getItem('ah_token');
    if (token) headers['Authorization'] = 'Bearer ' + token;

    // fetch com tratamento robusto de erros
    try {
        const res = await fetch(url, { method: opts.method || 'GET', headers, body: opts.body, cache: opts.cache || 'no-store' });
        const text = await res.text().catch(()=>'');
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        const body = ct.includes('application/json') && text ? JSON.parse(text) : text;
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} - ${typeof body === 'string' ? body : JSON.stringify(body)}`);
        return body;
    } catch (err) {
        // normaliza TypeError de rede
        if (err instanceof TypeError) {
            throw new Error(`Network error: ${err.message}. Verifique API_BASE (${API_BASE}) e se a API está acessível a partir deste navegador.`);
        }
        throw err;
    }
}

/* ========== UTILITÁRIOS LOCAIS ========== */
const selProf = document.getElementById("profissional");
const filtroData = document.getElementById("filtro-data");
const filtroStatus = document.getElementById("filtro-status");
const tbody = document.getElementById("tbody");
const erro = document.getElementById("erro");
const btnHoje = document.getElementById("btn-hoje");

document.getElementById("voltar").onclick = () => {
    if (document.referrer && document.referrer !== location.href) history.back();
    else window.location.href = "index.html";
};

function hojeIso() { return new Date().toISOString().slice(0,10); }
filtroData.value = hojeIso();

btnHoje.onclick = () => { filtroData.value = hojeIso(); carregar(); };
document.getElementById("btn-filtrar").onclick = carregar;
selProf.onchange = carregar;

function statusKey(status) {
    if (!status) return "pendente";
    try {
        return status.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
    } catch { return String(status).toLowerCase(); }
}

function fmtData(dt) {
    try {
        const d = new Date(dt);
        if (isNaN(d)) return dt;
        return d.toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});
    } catch { return dt; }
}

/* ========== Resolver estabelecimento do usuário logado (se existir) ========== */
async function resolveEstabId() {
    try {
        // tenta rota pública /usuario/logado que já existe no seu backend
        const res = await getJson('/usuario/logado');
        // formato retornado pode ter { estabelecimentoId } ou { estabId } ou similar
        return res?.estabelecimentoId ?? res?.estabId ?? res?.estab?.id ?? null;
    } catch (ex) {
        // não fatal — apenas fallback para 1 (desenvolvimento)
        console.warn('resolveEstabId falhou:', ex.message);
        return null;
    }
}

/* ========== Carregar profissionais (usando URL absoluta garantida) ========== */
async function carregarProfissionais() {
    try {
        let estabId = await resolveEstabId();
        const finalEstab = estabId ?? 1; // fallback para dev
        const js = await getJson(`/profissionais/${finalEstab}`);
        // suporta { data: [...] } ou [...]
        const profs = (js?.data && Array.isArray(js.data)) ? js.data : (Array.isArray(js) ? js : []);
        if (!profs.length) {
            selProf.innerHTML = `<option value="">Nenhum profissional</option>`;
            return;
        }
        selProf.innerHTML = `<option value="">-- Selecionar profissional --</option>` +
            profs.map(p => {
                const id = p.id ?? p.Id ?? p.ID ?? p.ID_PROFISSIONAL ?? p.IdProfissional;
                const nome = p.nome ?? p.Nome ?? p.NM_PROFISSIONAL ?? p.NomeProfissional ?? "Sem nome";
                return `<option value="${id}">${nome}</option>`;
            }).join("");
    } catch (e) {
        console.error("carregarProfissionais:", e);
        selProf.innerHTML = `<option value="">Erro ao carregar</option>`;
    }
}

/* ========== Render dos agendamentos ========== */
function render(lista) {
    if (!lista || !lista.length) {
        tbody.innerHTML = `<tr class="empty"><td colspan="5"><i class="fas fa-calendar-times"></i> Nenhum agendamento encontrado.</td></tr>`;
        return;
    }
    tbody.innerHTML = lista.map(a => {
        const cliente = a.cliente ?? a.Cliente ?? a.NM_CLIENTE ?? "—";
        const servico = a.servico ?? a.Servico ?? a.NM_SERVICO ?? "—";
        const profissional = a.profissional ?? a.Profissional ?? a.NM_PROFISSIONAL ?? "—";
        const dtInicio = a.dtInicio ?? a.DtInicio ?? a.DT_INICIO ?? a.DT_AGENDAMENTO ?? null;
        const st = a.status ?? a.Status ?? "Pendente";
        const key = statusKey(st);
        return `<tr>
            <td>${cliente}</td>
            <td>${servico}</td>
            <td>${profissional}</td>
            <td>${dtInicio ? fmtData(dtInicio) : "—"}</td>
            <td><span class="badge" data-status="${key}"><span class="badge-dot"></span>${st}</span></td>
        </tr>`;
    }).join("");
}

/* ========== Carregar agendamentos filtrados por profissional e dia ========== */
async function carregar() {
    erro.style.display = "none";
    tbody.innerHTML = `<tr class="empty"><td colspan="5"><i class="fas fa-spinner fa-spin"></i> Carregando agendamentos…</td></tr>`;

    const profId = selProf.value;
    if (!profId) {
        tbody.innerHTML = `<tr class="empty"><td colspan="5"><i class="fas fa-user-tie"></i> Selecione um profissional para visualizar.</td></tr>`;
        return;
    }

    const dia = filtroData.value || hojeIso();
    const ini = `${dia}T00:00:00`;
    const fim = `${dia}T23:59:59`;
    let url = `/agendamentos/profissional?profissionalId=${encodeURIComponent(profId)}&ini=${encodeURIComponent(ini)}&fim=${encodeURIComponent(fim)}`;
    if (filtroStatus.value) url += `&status=${encodeURIComponent(filtroStatus.value)}`;

    try {
        const js = await getJson(url);
        const lista = (js?.data && Array.isArray(js.data)) ? js.data : (Array.isArray(js) ? js : []);
        render(lista);
    } catch (e) {
        console.error("carregar:", e);
        erro.style.display = "flex";
        tbody.innerHTML = `<tr class="empty"><td colspan="5"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar agendamentos.</td></tr>`;
    }
}

/* ========== Inicialização ========== */
(async function init() {
    try {
        await carregarProfissionais();
        await carregar();
    } catch (e) {
        console.error("init:", e);
        erro.style.display = "flex";
    }
})();
</script>

</body>
</html>
