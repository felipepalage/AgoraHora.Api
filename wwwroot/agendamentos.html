<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Agendamentos - AgoraHora</title>
<style>
  :root{--brand-navy:#0f2b5c;--brand-teal:#19b7a6;--brand-teal-hover:#139987;--bg:#f5f7fa;--card:#fff;--muted:#8a94a6}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#1c2430;font:500 15px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{background:#fff;border-bottom:1px solid #e9eef5;position:sticky;top:0;z-index:10}
  .top{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;gap:14px;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px}.brand svg{width:34px;height:34px}.brand .name{font-weight:800;font-size:20px;color:var(--brand-navy)}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:var(--brand-teal);color:#fff;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--brand-teal-hover)}
  .container{max-width:1200px;margin:24px auto;padding:0 20px}
  .card{background:var(--card);border-radius:20px;padding:20px;box-shadow:0 16px 40px rgba(15,43,92,.06),0 4px 12px rgba(15,43,92,.05)}
  .searchbar{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  input,select{width:100%;padding:10px 12px;border:1px solid #e3e8ef;border-radius:10px;outline:none}
  input:focus,select:focus{box-shadow:0 0 0 4px rgba(25,183,166,.12)}
  table{width:100%;border-collapse:collapse} th,td{padding:12px 10px;border-bottom:1px solid #eef2f7;text-align:left} th{color:#30405a;font-size:13px}
  .badge{display:inline-block;padding:4px 8px;border-radius:10px;font-size:12px;background:#eefaf8;color:#0d6e64}
  .empty{color:var(--muted);padding:6px 0}
  .error{margin-top:10px;color:#c62828;font-weight:700;display:none}
  @media(min-width:800px){ .searchbar > *{flex:1} .searchbar button{flex:0 0 auto} }
</style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand" aria-label="AgoraHora">
      <svg viewBox="0 0 64 64" aria-hidden="true"><circle cx="32" cy="32" r="28" fill="none" stroke="#19b7a6" stroke-width="6"/><path d="M20 33.5l7 7 17-17" fill="none" stroke="#19b7a6" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div class="name">AgoraHora</div>
    </div>
    <button class="btn" id="voltar">Voltar</button>
  </div>
</header>

<main class="container">
  <div class="card">
    <h2 style="margin-top:0;color:var(--brand-navy)">Agendamentos</h2>
    <div class="searchbar">
      <select id="profissional"></select>
      <input id="filtro-data" type="date"/>
      <select id="filtro-status" title="Status">
        <option value="">Todos</option>
        <option value="Pendente">Pendente</option>
        <option value="Confirmado">Confirmado</option>
        <option value="Cancelado">Cancelado</option>
        <option value="Concluido">Concluído</option>
      </select>
      <button class="btn" id="btn-filtrar">Filtrar</button>
    </div>
    <table>
      <thead><tr><th>Cliente</th><th>Serviço</th><th>Profissional</th><th>Data</th><th>Status</th></tr></thead>
      <tbody id="tbody"><tr><td class="empty" colspan="5">Carregando…</td></tr></tbody>
    </table>
    <div id="erro" class="error">Não foi possível carregar os agendamentos.</div>
  </div>
</main>

<script>
  const API_BASE = 'http://localhost:7050/api'; // ajuste se necessário
  const qs = new URLSearchParams(location.search);
  const estabelecimentoId = Number(qs.get('estabelecimentoId') || 1);

  const selProf   = document.getElementById('profissional');
  const filtroData   = document.getElementById('filtro-data');
  const filtroStatus = document.getElementById('filtro-status');
  const tbody = document.getElementById('tbody');
  const erro  = document.getElementById('erro');

  // ===== BOTÃO VOLTAR =====
  document.getElementById('voltar').onclick = () => {
    if (document.referrer && document.referrer !== location.href)
      history.back();
    else
      window.location.href = 'index.html';
  };

  filtroData.value = new Date().toISOString().slice(0,10);
  document.getElementById('btn-filtrar').onclick = carregar;
  selProf.onchange = carregar;

  const fmt = d => new Date(d).toLocaleString('pt-BR',{
    day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'
  });

  async function j(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  async function carregarProfissionais(){
    const url = `${API_BASE}/profissionais/${estabelecimentoId}`;
    const js = await j(url);
    const profs = js.data ?? js;
    selProf.innerHTML = profs.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
  }

  async function carregar(){
    erro.style.display = 'none';
    tbody.innerHTML = `<tr><td class="empty" colspan="5">Carregando…</td></tr>`;

    const dia = filtroData.value || new Date().toISOString().slice(0,10);
    const ini = `${dia}T00:00:00`;
    const fim = `${dia}T23:59:59`;
    const profId = selProf.value;

    if(!profId){
      tbody.innerHTML = `<tr><td class="empty" colspan="5">Selecione um profissional.</td></tr>`;
      return;
    }

    const url = `${API_BASE}/agendamentos/profissional` +
                `?profissionalId=${encodeURIComponent(profId)}` +
                `&ini=${encodeURIComponent(ini)}` +
                `&fim=${encodeURIComponent(fim)}` +
                (filtroStatus.value ? `&status=${encodeURIComponent(filtroStatus.value)}` : '');

    try{
      const js = await j(url);
      const list = js.data ?? [];
      render(list);
    }catch(e){
      console.error(e);
      erro.style.display = 'block';
      tbody.innerHTML = `<tr><td class="empty" colspan="5">Sem dados.</td></tr>`;
    }
  }

  function render(lista){
    if(!lista.length){
      tbody.innerHTML = `<tr><td class="empty" colspan="5">Nenhum agendamento para os filtros.</td></tr>`;
      return;
    }
    tbody.innerHTML = lista.map(a => `
      <tr>
        <td>${a.cliente ?? '—'}</td>
        <td>${a.servico ?? '—'}</td>
        <td>${a.profissional ?? '—'}</td>
        <td>${fmt(a.dtInicio)}</td>
        <td><span class="badge">${a.status ?? 'Pendente'}</span></td>
      </tr>
    `).join('');
  }

  (async function init(){
    await carregarProfissionais();
    await carregar();
  })();
</script>
</body>
</html>
