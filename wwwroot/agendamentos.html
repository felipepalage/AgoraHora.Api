<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendamentos - AgoraHora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{
            --brand-navy:#0a1933;
            --brand-teal:#0da5a0;
            --border:#e2e8f0;
            --card:#ffffff;
            --muted:#64748b;
            --danger:#ef4444;
            --radius-md:14px;
            --shadow-medium: 0 10px 25px rgba(10,25,51,.08);
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font:500 15px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            background:linear-gradient(135deg,#f8fafc 0,#e2e8f0 100%);
            color:#334155
        }
        header{
            background:rgba(255,255,255,.9);
            border-bottom:1px solid rgba(226,232,240,.6);
            backdrop-filter:blur(16px);
            position:sticky;
            top:0;
            z-index:20
        }
        .top{
            max-width:1200px;
            margin:auto;
            padding:14px 20px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px
        }
        .brand{display:flex;gap:12px;align-items:center}
        .brand-icon{
            width:40px;
            height:40px;
            border-radius:12px;
            background:linear-gradient(135deg,var(--brand-teal),#6366f1);
            display:flex;
            align-items:center;
            justify-content:center;
            color:#fff
        }
        .name{
            font-weight:700;
            font-size:18px;
            color:var(--brand-navy);
        }
        .btn{
            padding:10px 18px;
            border-radius:999px;
            border:0;
            background:linear-gradient(135deg,var(--brand-teal),#098581);
            color:#fff;
            cursor:pointer;
            font-weight:600;
            display:inline-flex;
            gap:8px;
            align-items:center;
            font-size:14px;
            box-shadow:0 8px 20px rgba(13,165,160,.2);
            transition:transform .1s ease, box-shadow .1s ease, filter .1s ease;
        }
        .btn:hover{
            filter:brightness(1.05);
            box-shadow:0 10px 30px rgba(13,165,160,.25);
            transform:translateY(-1px);
        }
        .btn:active{
            transform:translateY(0);
            box-shadow:0 4px 14px rgba(13,165,160,.2);
        }

        .container{max-width:1200px;margin:24px auto;padding:0 20px}
        .page-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            margin-bottom:24px
        }
        .page-header h2{
            font-size:22px;
            display:flex;
            align-items:center;
            gap:8px;
            color:var(--brand-navy);
        }
        .page-header h2 i{
            font-size:20px;
        }

        .filters{
            display:grid;
            grid-template-columns:1fr 1fr 1fr auto;
            gap:16px;
            margin-bottom:20px
        }
        @media(max-width:768px){
            .filters{
                grid-template-columns:1fr;
            }
            .filters > div:last-child{
                display:flex;
                justify-content:flex-end;
            }
        }

        .field label{
            font-weight:600;
            margin-bottom:6px;
            display:flex;
            align-items:center;
            gap:6px;
            color:var(--brand-navy);
            font-size:14px;
        }
        .field select,
        .field input{
            width:100%;
            padding:12px 16px;
            border-radius:var(--radius-md);
            border:1px solid var(--border);
            background:#f8fafc;
            outline:none;
            transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
        }
        .field select:focus,
        .field input:focus{
            border-color:var(--brand-teal);
            background:#ffffff;
            box-shadow:0 0 0 1px rgba(13,165,160,0.1);
        }

        .table-wrapper{
            overflow-x:auto;
            border-radius:var(--radius-md);
            border:1px solid var(--border);
            background:var(--card);
            box-shadow:var(--shadow-medium)
        }
        table{width:100%;border-collapse:collapse}
        th,td{
            padding:14px 16px;
            border-bottom:1px solid var(--border);
            text-align:left
        }
        th{
            color:var(--brand-navy);
            font-size:13px;
            font-weight:700;
            text-transform:uppercase
        }

        th:nth-child(1),
        td:nth-child(1){
            min-width:180px;
        }
        th:nth-child(2),
        td:nth-child(2){
            min-width:180px;
        }
        th:nth-child(4),
        td:nth-child(4){
            white-space:nowrap;
        }
        td{
            font-size:14px;
        }

        tbody tr:nth-child(odd):not(.empty){
            background:#f8fafc;
        }
        tbody tr:hover:not(.empty){
            background:#e5f0ff;
            transition:background-color .15s ease;
        }

        .empty{
            padding:20px;
            text-align:center;
            color:var(--muted);
            font-style:italic
        }

        .badge{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:6px 12px;
            border-radius:999px;
            font-weight:600;
            text-transform:uppercase;
            font-size:11px;
            letter-spacing:.04em;
            border:1px solid transparent;
        }

        /* Pendente */
        .badge[data-status="pendente"]{
            background:#fef3c7;
            color:#92400e;
            border-color:#facc15;
        }

        /* Confirmado */
        .badge[data-status="confirmado"]{
            background:#dcfce7;
            color:#166534;
            border-color:#22c55e;
        }

        /* Cancelado */
        .badge[data-status="cancelado"]{
            background:#fee2e2;
            color:#b91c1c;
            border-color:#ef4444;
        }

        /* Concluido (sem acento, pois já foi normalizado) */
        .badge[data-status="concluido"]{
            background:#e0f2fe;
            color:#075985;
            border-color:#38bdf8;
        }

        .error-message{
            margin-top:16px;
            padding:12px 16px;
            border-radius:12px;
            background:#fee2e2;
            border-left:4px solid var(--danger);
            color:var(--danger);
            font-weight:600;
            display:none;
            align-items:center;
        }
        .small-muted{
            font-size:13px;
            color:var(--muted)
        }
    </style>
</head>
<body>
    <header>
      <div class="top">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-calendar-check"></i></div>
            <div class="name">AgoraHora</div>
        </div>
        <button class="btn" id="voltar"><i class="fas fa-arrow-left"></i> Voltar</button>
      </div>
    </header>

    <main class="container">
        <div class="page-header">
            <div>
                <h2><i class="fas fa-calendar-alt"></i> Agendamentos</h2>
                <p class="small-muted" style="margin-top:4px">
                    Veja os horários do dia por profissional e status.
                </p>
            </div>
            <div>
                <button class="btn" id="btn-hoje"><i class="fas fa-calendar-day"></i> Hoje</button>
            </div>
        </div>

        <div class="filters" role="region" aria-label="Filtros">
            <div class="field">
                <label><i class="fas fa-user-tie"></i> Profissional</label>
                <select id="profissional" aria-label="Profissional"></select>
                <div id="prof-help" class="small-muted" style="margin-top:6px">
                    Selecione para ver agendamentos do dia.
                </div>
            </div>
            <div class="field">
                <label><i class="fas fa-calendar"></i> Data</label>
                <input type="date" id="filtro-data" aria-label="Data">
            </div>
            <div class="field">
                <label><i class="fas fa-info-circle"></i> Status</label>
                <select id="filtro-status" aria-label="Status">
                    <option value="">Todos</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Cancelado">Cancelado</option>
                    <option value="Concluido">Concluído</option>
                </select>
            </div>
            <div style="display:flex;align-items:end">
                <button class="btn" id="btn-filtrar"><i class="fas fa-search"></i> Filtrar</button>
            </div>
        </div>

        <div class="table-wrapper" id="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th scope="col">Cliente</th>
                        <th scope="col">Serviço</th>
                        <th scope="col">Profissional</th>
                        <th scope="col">Data e horário</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody id="tbody" aria-live="polite">
                    <tr class="empty">
                        <td colspan="5">
                            <i class="fas fa-spinner fa-spin"></i> Carregando agendamentos…
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="erro" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span style="margin-left:8px">Não foi possível carregar os agendamentos.</span>
        </div>
    </main>

<script>

const API_BASE = window.API_BASE || "http://179.0.176.111:5000/api";
const API_ROOT = API_BASE.replace(/\/$/, '');
console.info("API_BASE =", API_BASE);


(function authGuard() {
    const token = localStorage.getItem("ah_token");
    if (!token) {
        window.location.href = "login.html";
        return;
    }
})();


const selProf = document.getElementById("profissional");
const filtroData = document.getElementById("filtro-data");
const filtroStatus = document.getElementById("filtro-status");
const tbody = document.getElementById("tbody");
const erro = document.getElementById("erro");
const btnHoje = document.getElementById("btn-hoje");
const btnFiltrar = document.getElementById("btn-filtrar");
const profHelp = document.getElementById("prof-help");

document.getElementById("voltar").onclick = () => {
    if (document.referrer && document.referrer !== location.href) history.back();
    else window.location.href = "index.html";
};

function hojeIso(){
    const d = new Date();
    const ano = d.getFullYear();
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const dia = String(d.getDate()).padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
}
filtroData.value = hojeIso();

btnHoje.onclick = () => { filtroData.value = hojeIso(); carregar(); };
btnFiltrar.onclick = carregar;
selProf.onchange = carregar;

function statusKey(status){
    if(!status) return "pendente";
    return String(status)
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"")
        .toLowerCase();
}

function fmtData(dt){
    try{
        const d = new Date(dt);
        if(isNaN(d)) return String(dt);
        return d.toLocaleString("pt-BR", {
            day:"2-digit",
            month:"2-digit",
            hour:"2-digit",
            minute:"2-digit"
        });
    }catch{
        return String(dt);
    }
}


async function fetchWithTimeout(resource, options = {}) {
    const { timeout = 10000 } = options;
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);

    try {
        const res = await fetch(resource, { signal: controller.signal, ...options });
        clearTimeout(id);
        return res;
    } catch (err) {
        clearTimeout(id);
        throw err;
    }
}

async function getJson(url) {
    if (!/^https?:\/\//i.test(url)) {
        url = API_ROOT + '/' + url.replace(/^\/+/, '');
    }

    const headers = { 'Accept': 'application/json' };
    const token = localStorage.getItem('ah_token');
    if (token) headers['Authorization'] = 'Bearer ' + token;

    try {
        const r = await fetchWithTimeout(url, {
            headers,
            cache: 'no-store',
            timeout: 12000
        });

        const ct = r.headers.get('content-type') || '';

        if (!r.ok) {
            if (r.status === 401) {
                localStorage.removeItem('ah_token');
                localStorage.removeItem('ah_estab');
                window.location.href = 'login.html';
                throw new Error('Não autorizado (401)');
            }

            let bodyText = '';
            try {
                bodyText = ct.includes('json')
                    ? JSON.stringify(await r.json())
                    : await r.text();
            } catch {
                bodyText = '';
            }

            throw new Error(`HTTP ${r.status} - ${bodyText || r.statusText}`);
        }

        if (ct.includes('json')) return r.json();

        const txt = await r.text();
        try {
            return JSON.parse(txt);
        } catch {
            return txt;
        }

    } catch (err) {
        if (err.name === 'AbortError') throw new Error('Request timeout');
        throw err;
    }
}

async function resolveEstabId(){
    const token = localStorage.getItem('ah_token');
    if (!token) return null;

    const headers = {
        'Accept':'application/json',
        'Authorization': 'Bearer ' + token
    };

    try {
        const r = await fetch(API_ROOT + '/usuarios/me/estabelecimentos', {
            headers,
            cache:'no-store'
        });

        if (r.status === 401) {
            localStorage.removeItem('ah_token');
            window.location.href='login.html';
            return null;
        }

        if (r.ok) {
            const data = await r.json();
            if (Array.isArray(data) && data.length) {
                return data[0].estabelecimentoId
                    ?? data[0].EstabelecimentoId
                    ?? null;
            }
        }
    } catch (e) {
        console.warn('estabs failed', e);
    }

    try {
        const r2 = await fetch(API_ROOT + '/usuarios/me', {
            headers,
            cache:'no-store'
        });

        if (r2.status === 401) {
            localStorage.removeItem('ah_token');
            window.location.href='login.html';
            return null;
        }

        if (r2.ok) {
            const j = await r2.json();
            return j?.estabelecimentoId ?? j?.estabId ?? null;
        }
    } catch (e) {
        console.warn('me failed', e);
    }

    return null;
}

async function carregarProfissionais() {
    selProf.innerHTML = `<option value="">Carregando...</option>`;

    try {
        const estabSaved = Number(localStorage.getItem("ah_estab")) || null;
        const estabResolved = await resolveEstabId();
        const finalEstab = estabSaved || estabResolved || 1;

        const url = `${API_ROOT}/profissionais/${finalEstab}`;
        const js = await getJson(url);

        const profs = js?.data ?? js;

        if (!Array.isArray(profs) || !profs.length) {
            selProf.innerHTML = `<option value="">Nenhum profissional disponível</option>`;
            profHelp.textContent = 'Não existem profissionais cadastrados para este estabelecimento.';
            return;
        }

        selProf.innerHTML =
            `<option value="">-- Selecionar profissional --</option>` +
            profs.map(p => {
                const id =
                    p.id ?? p.Id ?? p.ID ?? p.ID_PROFISSIONAL ?? p.IdProfissional;
                const nome =
                    p.nome ?? p.Nome ?? p.NM_PROFISSIONAL ?? p.NomeProfissional ?? 'Sem nome';
                return `<option value="${id}">${nome}</option>`;
            }).join('');

        profHelp.textContent = '';
    } catch (e) {
        console.error("Erro carregar profissionais", e);
        selProf.innerHTML = `<option value="">Erro ao carregar</option>`;
        profHelp.textContent = 'Falha ao carregar profissionais. Verifique se a API está disponível e CORS/URL corretos.';
        throw e;
    }
}


function escapeHtml(s){
    return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
}

function render(lista) {
    if (!lista || !lista.length) {
        tbody.innerHTML =
            `<tr class="empty"><td colspan="5">Nenhum agendamento encontrado.</td></tr>`;
        return;
    }

    tbody.innerHTML = lista.map(a => {
        const cliente = a.cliente ?? a.Cliente ?? a.NM_CLIENTE ?? "—";
        const servico = a.servico ?? a.Servico ?? a.NM_SERVICO ?? "—";
        const profissional = a.profissional ?? a.Profissional ?? a.NM_PROFISSIONAL ?? "—";
        const dtInicio = a.dtInicio ?? a.DtInicio ?? a.DT_AGENDAMENTO ?? null;
        const st = a.status ?? a.Status ?? "Pendente";
        const key = statusKey(st);

        return `
        <tr>
            <td>${escapeHtml(cliente)}</td>
            <td>${escapeHtml(servico)}</td>
            <td>${escapeHtml(profissional)}</td>
            <td>${escapeHtml(dtInicio ? fmtData(dtInicio) : "—")}</td>
            <td><span class="badge" data-status="${key}">${escapeHtml(st)}</span></td>
        </tr>`;
    }).join('');
}

async function carregar(){
    erro.style.display = 'none';
    tbody.innerHTML =
        `<tr class="empty"><td colspan="5"><i class="fas fa-spinner fa-spin"></i> Carregando…</td></tr>`;

    const profId = selProf.value;
    if (!profId) {
        tbody.innerHTML =
            `<tr class="empty"><td colspan="5"><i class="fas fa-user-tie"></i> Selecione um profissional.</td></tr>`;
        return;
    }

    const dia = filtroData.value || hojeIso();
    const ini = `${dia}T00:00:00`;
    const fim = `${dia}T23:59:59`;

    let url =
        `${API_ROOT}/agendamentos/profissional` +
        `?profissionalId=${encodeURIComponent(profId)}` +
        `&ini=${encodeURIComponent(ini)}` +
        `&fim=${encodeURIComponent(fim)}`;

    if (filtroStatus.value)
        url += `&status=${encodeURIComponent(filtroStatus.value)}`;

    try {
        const js = await getJson(url);
        const lista = js?.data ?? js;
        render(lista);
    } catch (e) {
        console.error("Erro carregar agendamentos", e);
        erro.style.display = 'flex';
        erro.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span style="margin-left:8px">
                Erro ao carregar: ${escapeHtml(e.message || 'unknown')}
                <button
                    style="margin-left:12px;border:0;background:none;color:#b91c1c;cursor:pointer;text-decoration:underline;font-weight:600"
                    onclick="carregar()">
                    Tentar novamente
                </button>
            </span>`;
        tbody.innerHTML =
            `<tr class="empty"><td colspan="5"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar agendamentos. Veja detalhes acima.</td></tr>`;
    }
}


(async function init(){
    try {
        await carregarProfissionais();

        if (selProf.value)
            await carregar();

    } catch (e) {
        erro.style.display = 'flex';
        erro.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span style="margin-left:8px">
                Falha na inicialização: ${escapeHtml(e.message || 'Ver console')}
            </span>`;
    }
})();
</script>

</body>
</html>
