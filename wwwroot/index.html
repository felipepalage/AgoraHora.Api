<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - AgoraHora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --brand-navy: #0a1933;
            --brand-teal: #0da5a0;
            --brand-teal-hover: #098581;
            --brand-teal-soft: #e6f9f8;
            --brand-purple: #6366f1;
            --bg: #f8fafc;
            --card: #ffffff;
            --muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --radius-lg: 20px;
            --radius-md: 14px;
            --radius-sm: 8px;
            --shadow-soft: 0 4px 15px rgba(10,25,51,.05);
            --shadow-medium: 0 10px 25px rgba(10,25,51,.08);
            --shadow-strong: 0 20px 40px rgba(10,25,51,.12);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #334155;
            font: 500 15px/1.45 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            min-height: 100vh;
        }

        header {
            background: rgba(255,255,255,.9);
            border-bottom: 1px solid rgba(226,232,240,.6);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(16px);
            box-shadow: var(--shadow-soft);
        }

        .top {
            max-width: 1200px;
            margin: auto;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .brand:hover { transform: scale(1.02); }

        .brand-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(13,165,160,.25);
        }

        .brand-icon i { color: white; font-size: 20px; }

        .brand .name { font-weight: 800; font-size: 22px; color: var(--brand-navy); }

        .user { display: flex; align-items: center; gap: 12px; color: var(--muted); }

        .user i { color: var(--brand-teal); }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-teal-hover));
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transition: left 0.3s ease;
        }

        .btn:hover::before { left: 100%; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13,165,160,.35); }

        .container { max-width: 1200px; margin: 24px auto; padding: 0 20px; }
        .grid { display: grid; gap: 20px; }
        @media(min-width:900px) { .grid-3 { grid-template-columns: repeat(3,1fr); } .grid-2 { grid-template-columns: 2fr 3fr; } }

        .card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(226,232,240,.6);
            transition: all 0.3s ease;
        }

        .card:hover { box-shadow: var(--shadow-strong); }

        .kpi {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .kpi::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-purple));
        }

        .kpi i { font-size: 24px; color: var(--brand-teal); margin-bottom: 10px; }
        .kpi h3 { margin: 0; font-size: 14px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi strong { font-size: 32px; color: var(--brand-navy); font-weight: 800; margin-top: 5px; }

        .actions { display: grid; gap: 12px; grid-template-columns: repeat(2,1fr); }
        .action {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            background: var(--card);
            text-decoration: none;
            color: var(--brand-navy);
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .action i { font-size: 20px; color: var(--brand-teal); }
        .action:hover { border-color: var(--brand-teal); transform: translateY(-2px); box-shadow: var(--shadow-soft); }

        .table-wrapper { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border); margin-top: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 14px; border-bottom: 1px solid var(--border); text-align: left; }
        th { color: var(--brand-navy); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; background: #f8fafc; }
        tbody tr { transition: background 0.2s ease; }
        tbody tr:hover { background: #f8fafc; }
        .empty { color: var(--muted); padding: 20px 0; text-align: center; font-style: italic; }

        .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge i { font-size: 10px; }
        .b-gray { background: #f1f5f9; color: #475569; }
        .b-red { background: #fee2e2; color: #b91c1c; }
        .b-orange { background: #fef3c7; color: #b45309; }
        .b-green { background: #d1fae5; color: #0f766e; }

        .status-wrap { position: relative; display: inline-block; }
        .status-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: #fff;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .status-btn:hover { box-shadow: 0 0 0 3px rgba(13,165,160,.15); border-color: var(--brand-teal); }
        .chev { font-size: 12px; color: var(--muted); transition: transform 0.2s ease; }
        .status-wrap:hover .chev { transform: rotate(180deg); }
        .status-menu {
            position: absolute;
            top: 110%;
            right: 0;
            min-width: 180px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-strong);
            padding: 8px;
            display: none;
            z-index: 20;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: background 0.2s ease; }
        .status-item:hover { background: var(--brand-teal-soft); }

        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .d-red { background: var(--danger); }
        .d-orange { background: var(--warning); }
        .d-green { background: var(--success); }
        .d-gray { background: var(--muted); }

        .searchbar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        input, select { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: var(--radius-md); outline: none; background: #f8fafc; font-size: 14px; transition: all 0.2s ease; }
        input:focus, select:focus { background: #ffffff; border-color: var(--brand-teal); box-shadow: 0 0 0 3px rgba(13,165,160,.15); }

        .error {
            margin-top: 12px;
            color: var(--danger);
            font-weight: 600;
            display: none;
            padding: 12px 16px;
            background: #fee2e2;
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--danger);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error i { font-size: 16px; }

        .legend { color: var(--muted); font-size: 13px; margin-bottom: 12px; font-style: italic; }

        .grid-1 { display: grid; gap: 20px; }

        /* Responsividade */
        @media(max-width:768px) { .table-wrapper { border: none; overflow-x: visible; } table { display: none; } .mobile-cards { display: block; } }
        @media(min-width:769px) { .mobile-cards { display: none; } }
    </style>
</head>
<body>
<header>
    <div class="top">
        <div class="brand" aria-label="AgoraHora">
            <div class="brand-icon"><i class="fas fa-chart-line"></i></div>
            <div class="name">AgoraHora</div>
        </div>
        <div class="user">
            <i class="fas fa-user-circle"></i>
            <span id="usuario-nome">Bem-vindo!</span>
            <button class="btn" id="logout"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </div>
</header>

<main class="container grid-1">
    <section class="grid grid-3">
        <div class="card kpi">
            <i class="fas fa-calendar-check"></i>
            <h3>Agendados</h3>
            <strong id="kpi-hoje">–</strong>
        </div>
        <div class="card kpi">
            <i class="fas fa-user-check"></i>
            <h3>Atendidos</h3>
            <strong id="kpi-atendidos">–</strong>
        </div>
        <div class="card kpi">
            <i class="fas fa-calendar-times"></i>
            <h3>Cancelados</h3>
            <strong id="kpi-cancelados">–</strong>
        </div>
    </section>

    <section class="grid grid-2">
        <div class="card">
            <h2 class="section-title"><i class="fas fa-th-large"></i> Acesso rápido</h2>
            <div class="actions">
                <a class="action" href="agendamentos.html"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
                <a class="action" href="servicos.html"><i class="fas fa-concierge-bell"></i> Serviços</a>
                <a class="action" href="profissionais.html"><i class="fas fa-user-tie"></i> Profissionais</a>
                <a class="action" href="configuracoes.html?estab=1"><i class="fas fa-cog"></i> Configurações</a>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title"><i class="fas fa-list"></i> Agendamentos recentes</h2>
            <div class="searchbar">
                <input id="filtro-data" type="date" />
                <select id="filtro-status">
                    <option value="">Todos os status</option>
                    <option value="PENDENTE">Pendente</option>
                    <option value="CONFIRMADO">Confirmado</option>
                    <option value="CONCLUIDO">Concluído</option>
                    <option value="CANCELADO">Cancelado</option>
                </select>
                <button class="btn" id="btn-filtrar"><i class="fas fa-filter"></i> Filtrar</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Profissional</th>
                            <th>Data</th>
                            <th>Hora</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-agendamentos">
                        <tr><td class="empty" colspan="6">Carregando…</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mobile-cards" id="mobile-cards"><div class="empty">Carregando…</div></div>
            <div id="erro" class="error"><i class="fas fa-exclamation-circle"></i> Não foi possível carregar os agendamentos.</div>
        </div>
    </section>
</main>

<script>
    const token = localStorage.getItem('ah_token');
    if (!token) location.replace('login.html');

    document.getElementById('logout').onclick = () => {
        localStorage.removeItem('ah_token');
        localStorage.removeItem('ah_estabelecimentoId');
        localStorage.removeItem('ah_user_name');
        location.href = 'login.html';
    };

    async function api(path) {
        const r = await fetch('/api'+path, { headers:{ Authorization:'Bearer '+token }});
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
    }

    async function apiPatch(path, body){
        const r = await fetch('/api'+path, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body:JSON.stringify(body) });
        if(!r.ok) throw new Error('HTTP '+r.status);
    }

    const PROFISSIONAL_ID = 1;
    const fmtData = d => new Date(d).toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
    const fmtHora = d => new Date(d).toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });

    const kHoje = document.getElementById('kpi-hoje');
    const kAtendidos = document.getElementById('kpi-atendidos');
    const kCancelados = document.getElementById('kpi-cancelados');
    const tbody = document.getElementById('tbody-agendamentos');
    const mobileCards = document.getElementById('mobile-cards');
    const erro = document.getElementById('erro');
    const filtroData = document.getElementById('filtro-data');
    const filtroStatus = document.getElementById('filtro-status');

    function criaStatusBadge(status){
        let cls = 'b-gray', dot = 'd-gray';
        switch(status){
            case 'PENDENTE': cls='b-gray'; dot='d-gray'; break;
            case 'CONFIRMADO': cls='b-green'; dot='d-green'; break;
            case 'CONCLUIDO': cls='b-teal'; dot='d-green'; break;
            case 'CANCELADO': cls='b-red'; dot='d-red'; break;
        }
        return `<span class="badge ${cls}"><span class="dot ${dot}"></span>${status}</span>`;
    }

    function criaLinha(a){
        return `<tr data-id="${a.id}">
            <td>${a.cliente}</td>
            <td>${a.servico}</td>
            <td>${a.profissional}</td>
            <td>${fmtData(a.data)}</td>
            <td>${fmtHora(a.data)}</td>
            <td>
                <div class="status-wrap">
                    <div class="status-btn">${criaStatusBadge(a.status)}<span class="chev"><i class="fas fa-chevron-down"></i></span></div>
                    <div class="status-menu">
                        <div class="status-item" data-role="set" data-status="PENDENTE">${criaStatusBadge('PENDENTE')}</div>
                        <div class="status-item" data-role="set" data-status="CONFIRMADO">${criaStatusBadge('CONFIRMADO')}</div>
                        <div class="status-item" data-role="set" data-status="CONCLUIDO">${criaStatusBadge('CONCLUIDO')}</div>
                        <div class="status-item" data-role="set" data-status="CANCELADO">${criaStatusBadge('CANCELADO')}</div>
                    </div>
                </div>
            </td>
        </tr>`;
    }

    function criaCard(a){
        return `<div class="card" data-id="${a.id}">
            <div><strong>${a.cliente}</strong></div>
            <div>${a.servico}</div>
            <div>${a.profissional}</div>
            <div>${fmtData(a.data)} ${fmtHora(a.data)}</div>
            <div>${criaStatusBadge(a.status)}</div>
        </div>`;
    }

    async function carregaAgendamentos(){
        try {
            erro.style.display='none';
            const data = filtroData.value ? `?data=${filtroData.value}` : '';
            const status = filtroStatus.value ? `&status=${filtroStatus.value}` : '';
            const res = await api(`/agendamentos${data}${status}`);
            kHoje.textContent=res.filter(a=>a.status==='PENDENTE').length;
            kAtendidos.textContent=res.filter(a=>a.status==='CONCLUIDO').length;
            kCancelados.textContent=res.filter(a=>a.status==='CANCELADO').length;
            tbody.innerHTML = res.length ? res.map(criaLinha).join('') : '<tr><td class="empty" colspan="6">Nenhum agendamento</td></tr>';
            mobileCards.innerHTML = res.length ? res.map(criaCard).join('') : '<div class="empty">Nenhum agendamento</div>';
        } catch(e){
            erro.style.display='flex';
            tbody.innerHTML = '<tr><td class="empty" colspan="6">Erro ao carregar</td></tr>';
            mobileCards.innerHTML = '<div class="empty">Erro ao carregar</div>';
        }
    }

    document.getElementById('btn-filtrar').onclick = carregaAgendamentos;

    document.addEventListener('click', async e => {
        // toggle menu
        if(e.target.closest('.status-btn')){
            const wrap = e.target.closest('.status-wrap');
            const menu = wrap.querySelector('.status-menu');
            menu.style.display = menu.style.display==='block'?'none':'block';
            return;
        }

        // selecionar status
        const item = e.target.closest('.status-item[data-role="set"]');
        if(item){
            const wrap = item.closest('.status-wrap');
            const id = wrap.closest('tr, .card').dataset.id;
            const novoStatus = item.dataset.status;
            try {
                await apiPatch(`/agendamentos/${id}/status`, { status: novoStatus });
                // atualizar visual
                wrap.querySelector('.status-btn').innerHTML = criaStatusBadge(novoStatus) + '<span class="chev"><i class="fas fa-chevron-down"></i></span>';
                wrap.querySelector('.status-menu').style.display='none';
            } catch(err){
                alert('Erro ao atualizar status');
            }
        }

        // fechar menus se clicar fora
        if(!e.target.closest('.status-wrap')){
            document.querySelectorAll('.status-menu').forEach(m=>m.style.display='none');
        }
    });

    window.addEventListener('load', carregaAgendamentos);
</script>
</body>
</html>
