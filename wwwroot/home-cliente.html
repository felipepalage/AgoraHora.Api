<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Escolha sua Barbearia - AgoraHora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --brand-navy: #0a1933;
            --brand-teal: #0da5a0;
            --brand-teal-hover: #098581;
            --brand-teal-soft: #e6f9f8;
            --brand-purple: #6366f1;
            --bg: #f8fafc;
            --card: #ffffff;
            --muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --radius-lg: 20px;
            --radius-md: 14px;
            --radius-sm: 8px;
            --shadow-soft: 0 4px 15px rgba(10,25,51,.05);
            --shadow-medium: 0 10px 25px rgba(10,25,51,.08);
            --shadow-strong: 0 20px 40px rgba(10,25,51,.12);
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #334155;
            font: 500 15px/1.5 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif
        }

        header {
            background: rgba(255,255,255,.9);
            border-bottom: 1px solid rgba(226,232,240,.6);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(16px);
            box-shadow: var(--shadow-soft);
        }

        .top {
            max-width: 1200px;
            margin: auto;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            justify-content: space-between
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

            .brand:hover {
                transform: scale(1.02);
            }

        .brand-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(13,165,160,.25);
        }

            .brand-icon i {
                color: white;
                font-size: 20px;
            }

        .brand .name {
            font-weight: 800;
            font-size: 22px;
            color: var(--brand-navy)
        }

        .hero {
            background: linear-gradient(135deg, rgba(13,165,160,0.1) 0%, rgba(10,25,51,0.05) 100%), radial-gradient(circle at 90% -20%, rgba(13,165,160,.18), transparent 60%),radial-gradient(circle at -10% 10%, rgba(10,25,51,.12), transparent 60%),linear-gradient(180deg,#fff,#f7fbfa);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
        }

        .hero-wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 22px 20px 18px;
            text-align: center
        }

        .hero h1 {
            margin: 0;
            color: var(--brand-navy);
            font-size: clamp(24px,4.2vw,32px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

            .hero h1 i {
                color: var(--brand-teal);
            }

        .hero p {
            margin: 10px 0 0;
            color: var(--muted);
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 24px auto 32px;
            padding: 0 20px
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
            padding: 20px;
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            min-width: 240px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .filter-label i {
                color: var(--brand-teal);
            }

        .filters input, .filters select {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            outline: none;
            font-size: 14px;
            background: #f8fafc;
            transition: all 0.2s ease;
        }

            .filters input:focus, .filters select:focus {
                background: #ffffff;
                border-color: var(--brand-teal);
                box-shadow: 0 0 0 3px rgba(13,165,160,.15);
            }

        .chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .chip {
            padding: 10px 16px;
            border-radius: 999px;
            background: var(--brand-teal-soft);
            color: var(--brand-navy);
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--brand-teal);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

            .chip i {
                color: var(--brand-teal);
            }

            .chip:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 10px rgba(13,165,160,.15);
            }

            .chip.active {
                background: var(--brand-teal);
                color: #fff;
                border-color: var(--brand-teal);
                box-shadow: 0 4px 15px rgba(13,165,160,.25);
            }

                .chip.active i {
                    color: #fff;
                }

        .grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill,minmax(300px,1fr))
        }

        .card {
            background: var(--card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

            .card:hover {
                transform: translateY(-4px);
                box-shadow: var(--shadow-strong);
            }

        .thumb-container {
            position: relative;
            overflow: hidden;
            height: 180px;
        }

        .thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #f1f5f9;
            display: block;
            transition: transform 0.3s ease;
        }

        .card:hover .thumb {
            transform: scale(1.05);
        }

        .card-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .barbearia-nome {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--brand-navy);
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .barbearia-nome i {
                color: var(--brand-teal);
                font-size: 16px;
            }

        .barbearia-endereco {
            color: var(--muted);
            font-size: .95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .barbearia-endereco i {
                color: var(--brand-teal);
                font-size: 14px;
            }

        .meta {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .rating {
            font-size: 1rem;
            color: #f59e0b;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

            .badge.open {
                background: #d1fae5;
                color: #065f46;
            }

                .badge.open i {
                    color: var(--success);
                }

            .badge.off {
                background: #fee2e2;
                color: #991b1b;
            }

                .badge.off i {
                    color: var(--danger);
                }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 16px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--brand-teal), var(--brand-teal-hover));
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

            .btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: rgba(255,255,255,0.2);
                transition: left 0.3s ease;
            }

            .btn:hover::before {
                left: 100%;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(13,165,160,.35);
            }

        .fav-btn {
            background: #fff;
            border: 1px solid var(--border);
            font-size: 18px;
            cursor: pointer;
            color: #cbd5e1;
            line-height: 1;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

            .fav-btn:hover {
                transform: scale(1.1);
                border-color: var(--danger);
                color: var(--danger);
            }

            .fav-btn.active {
                color: var(--danger);
                border-color: var(--danger);
                background: #fff5f5;
            }

        .skeleton {
            background: var(--card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            animation: pulse 1.2s infinite;
            display: flex;
            flex-direction: column;
        }

        .sk-img {
            height: 180px;
            background: linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 37%,#f1f5f9 63%)
        }

        .sk-lines {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sk-line {
            height: 12px;
            background: linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 37%,#f1f5f9 63%);
            border-radius: var(--radius-sm);
        }

        @keyframes pulse {
            0% {
                opacity: .95
            }

            50% {
                opacity: .65
            }

            100% {
                opacity: .95
            }
        }

        .empty-wrap {
            background: var(--card);
            border: 1px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            color: var(--muted);
            grid-column: 1 / -1;
        }

            .empty-wrap i {
                font-size: 48px;
                color: var(--muted);
                margin-bottom: 16px;
            }

            .empty-wrap h3 {
                margin: 0 0 8px;
                color: var(--brand-navy);
            }

        @media(max-width:768px) {
            .filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="top">
            <div class="brand" aria-label="AgoraHora">
                <div class="brand-icon">
                    <i class="fas fa-cut"></i>
                </div>
                <div class="name">AgoraHora</div>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="hero-wrap">
            <h1><i class="fas fa-store"></i> Encontre o sal√£o perfeito</h1>
            <p>Busque, filtre e agende em poucos cliques ‚Äî simples e r√°pido.</p>
        </div>
    </section>

    <main class="container">
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label" for="search"><i class="fas fa-search"></i> Buscar</label>
                <input type="text" id="search" placeholder="Buscar barbearia..." aria-label="Buscar barbearia" />
            </div>
            <div class="filter-group">
                <label class="filter-label" for="filterOrder"><i class="fas fa-sort"></i> Ordenar</label>
                <select id="filterOrder" aria-label="Ordenar por">
                    <option value="">Ordenar por</option>
                    <option value="avaliacao">Melhor Avalia√ß√£o</option>
                    <option value="abertas">Apenas Abertas</option>
                </select>
            </div>
        </div>

        <div class="chips" id="chips">
            <button class="chip active" data-chip="todas"><i class="fas fa-border-all"></i> Todas</button>
            <button class="chip" data-chip="abertas"><i class="fas fa-door-open"></i> Aberta agora</button>
            <button class="chip" data-chip="top"><i class="fas fa-star"></i> Top avaliadas</button>
        </div>

        <div class="grid" id="lista-barbearias">
            <div class="skeleton">
                <div class="sk-img"></div>
                <div class="sk-lines">
                    <div class="sk-line" style="width:70%"></div>
                    <div class="sk-line" style="width:40%"></div>
                    <div class="sk-line" style="width:55%"></div>
                </div>
            </div>
            <div class="skeleton">
                <div class="sk-img"></div>
                <div class="sk-lines">
                    <div class="sk-line" style="width:60%"></div>
                    <div class="sk-line" style="width:45%"></div>
                    <div class="sk-line" style="width:55%"></div>
                </div>
            </div>
            <div class="skeleton">
                <div class="sk-img"></div>
                <div class="sk-lines">
                    <div class="sk-line" style="width:66%"></div>
                    <div class="sk-line" style="width:42%"></div>
                    <div class="sk-line" style="width:55%"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const lista = document.getElementById('lista-barbearias');
        const search = document.getElementById('search');
        const filterOrder = document.getElementById('filterOrder');
        const chips = document.getElementById('chips');

        const favKey = 'ah_favs';
        const favs = new Set(JSON.parse(localStorage.getItem(favKey) || '[]'));
        const saveFavs = () => localStorage.setItem(favKey, JSON.stringify([...favs]));

        const LOGO_URL = 'https://i.ibb.co/qMsd2zN4/barbershop-logo-barber-pole-razor-600nw-2535695609.webp';
        const FALLBACK_IMG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360">
              <rect width="100%" height="100%" fill="#f1f5f9"/>
              <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                    font-family="Inter, Arial, sans-serif" font-size="24" fill="#0a1933">
                <tspan x="50%" dy="-10">AgoraHora</tspan>
                <tspan x="50%" dy="30">Barbearia</tspan>
              </text>
            </svg>`
        );

        const logoKey = id => `logo_estab_${id}`;

        async function api(path) {
            const url = '/api' + path + (path.includes('?') ? '&' : '?') + '_ts=' + Date.now();
            const r = await fetch(url, { cache: 'no-store' });
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        }

        function normalizeImageUrl(u) {
            try {
                if (!u) return LOGO_URL;
                u = String(u).trim();
                if (u.startsWith('//')) return location.protocol + u;
                if (/^https?:/i.test(u)) {
                    const url = new URL(u);
                    url.pathname = url.pathname.split('/').map(encodeURIComponent).join('/');
                    return url.toString();
                }
                return LOGO_URL;
            } catch { return LOGO_URL; }
        }

        // Aberta local: lida com faixa cruzando 00:00
        function isOpenLocal(abreMin, fechaMin) {
            if (typeof abreMin !== 'number' || typeof fechaMin !== 'number') return false;
            const now = new Date();
            const nowMin = now.getHours() * 60 + now.getMinutes();
            return abreMin < fechaMin
                ? nowMin >= abreMin && nowMin < fechaMin
                : nowMin >= abreMin || nowMin < fechaMin;
        }

        function cardHTML(b) {
            const href = `barbearia.html?id=${b.id}`;
            const customLogo = localStorage.getItem(logoKey(b.id));
            const imgUrl = customLogo || normalizeImageUrl(b.img || LOGO_URL);

            // usa c√°lculo local se poss√≠vel; fallback no campo vindo do backend
            const abertaLocal = isOpenLocal(b.abreMin, b.fechaMin);
            const aberta = Number.isFinite(b.abreMin) && Number.isFinite(b.fechaMin) ? abertaLocal : !!b.aberta;

            return `
              <div class="card">
                <div class="thumb-container">
                  <img class="thumb" loading="lazy" src="${imgUrl}" alt="Foto da ${b.nome}"
                       onerror="this.onerror=null;this.src='${FALLBACK_IMG}'">
                </div>
                <div class="card-body">
                  <div>
                    <div class="barbearia-nome"><i class="fas fa-store"></i> ${b.nome}</div>
                    <div class="barbearia-endereco"><i class="fas fa-map-marker-alt"></i> ${b.endereco || ''}</div>
                    <div class="meta">
                      <div class="rating"><i class="fas fa-star"></i> ${Number(b.avaliacao ?? 0).toFixed(1)}</div>
                      <span class="badge ${aberta ? 'open' : 'off'}">
                        <i class="fas fa-${aberta ? 'check-circle' : 'times-circle'}"></i>
                        ${aberta ? 'Aberta agora' : 'Fechada'}
                      </span>
                    </div>
                  </div>
                  <div class="card-footer">
                    <a class="btn" href="${href}"><i class="fas fa-eye"></i> Ver detalhes</a>
                    <button class="fav-btn ${favs.has(b.id) ? 'active' : ''}" aria-pressed="${favs.has(b.id)}" title="Favoritar" data-id="${b.id}">
                      ${favs.has(b.id) ? '‚ù§Ô∏è' : 'ü§ç'}
                    </button>
                  </div>
                </div>
              </div>`;
        }

        function bindFavs() {
            lista.querySelectorAll('.fav-btn').forEach(btn => {
                const id = Number(btn.dataset.id);
                btn.addEventListener('click', e => {
                    e.preventDefault(); e.stopPropagation();
                    const active = btn.classList.toggle('active');
                    btn.textContent = active ? '‚ù§Ô∏è' : 'ü§ç';
                    btn.setAttribute('aria-pressed', active ? 'true' : 'false');
                    if (active) favs.add(id); else favs.delete(id);
                    saveFavs();
                });
            });
        }

        async function carregar() {
            const chip = chips.querySelector('.chip.active')?.dataset?.chip || 'todas';
            const abertasParam = chip === 'abertas' ? 'true' : '';
            const order = filterOrder.value || (chip === 'top' ? 'avaliacao' : '');
            const q = encodeURIComponent(search.value.trim());
            const resp = await api(`/estabelecimentos?q=${q}&order=${order}&abertas=${abertasParam}`);
            let data = resp.data ?? [];

            // Recalcula abertura local em todos os cards
            data = data.map(d => ({ ...d, aberta: isOpenLocal(d.abreMin, d.fechaMin) }));

            // Se chip "abertas" escolhido mas o backend filtrou errado por fuso, filtra no cliente
            if (chip === 'abertas') data = data.filter(d => d.aberta === true);

            return data;
        }

        function render(data) {
            if (!data.length) {
                lista.innerHTML = `
                    <div class="empty-wrap">
                        <i class="fas fa-search"></i>
                        <h3>Nenhuma barbearia encontrada</h3>
                        <p>Tente limpar os filtros ou usar termos diferentes.</p>
                    </div>`;
                return;
            }
            lista.innerHTML = data.map(cardHTML).join('');
            bindFavs();
        }

        async function applyFilters() {
            try { render(await carregar()); }
            catch {
                lista.innerHTML = `
                    <div class="empty-wrap">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar</h3>
                        <p>N√£o foi poss√≠vel carregar as barbearias no momento. Tente novamente mais tarde.</p>
                    </div>`;
            }
        }

        chips.addEventListener('click', e => {
            const btn = e.target.closest('.chip'); if (!btn) return;
            chips.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        });

        let t;
        search.addEventListener('input', () => {
            clearTimeout(t); t = setTimeout(applyFilters, 160);
        });
        filterOrder.addEventListener('change', applyFilters);

        applyFilters();

        // Recarrega quando Configura√ß√µes salva nome/endere√ßo/logo
        window.addEventListener('storage', ev => {
            if (!ev.key) return;
            if (ev.key.startsWith('logo_estab_') || ev.key.startsWith('estab_')) applyFilters();
        });
    </script>
</body>
</html>