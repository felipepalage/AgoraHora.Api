<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Profissionais - AgoraHora</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--brand-navy:#0a1933;--brand-teal:#0da5a0;--border:#e2e8f0;--card:#fff;--muted:#64748b;--radius-md:14px;--shadow-medium:0 10px 25px rgba(10,25,51,.08)}
*{box-sizing:border-box;margin:0;padding:0}
body{font:500 15px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:linear-gradient(135deg,#f8fafc 0,#e2e8f0 100%);color:#334155}
header{background:rgba(255,255,255,.9);border-bottom:1px solid rgba(226,232,240,.6);position:sticky;top:0;z-index:20;backdrop-filter:blur(16px)}
.top{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;gap:12px;align-items:center}
.brand-icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand-teal),#6366f1);display:flex;align-items:center;justify-content:center;color:#fff}
.btn{padding:10px 16px;border-radius:8px;border:0;background:linear-gradient(135deg,var(--brand-teal),#098581);color:#fff;cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center}
.container{max-width:1200px;margin:24px auto;padding:0 20px}
.card{background:var(--card);border-radius:var(--radius-md);padding:24px;box-shadow:var(--shadow-medium);border:1px solid rgba(226,232,240,.6);margin-bottom:20px}
label{display:block;margin:12px 0 6px;color:var(--brand-navy);font-weight:600}
input{width:100%;padding:12px 16px;border-radius:var(--radius-md);border:1px solid var(--border);background:#f8fafc}
.table-wrapper{overflow-x:auto;border-radius:var(--radius-md);border:1px solid var(--border);margin-top:16px}
table{width:100%;border-collapse:collapse}
th,td{padding:14px 16px;border-bottom:1px solid var(--border);text-align:left}
th{color:var(--brand-navy);font-size:13px;font-weight:700;text-transform:uppercase}
.empty{padding:20px;text-align:center;color:var(--muted);font-style:italic}
.tag{display:inline-block;padding:4px 8px;border-radius:8px;background:#e6f9f8;margin-right:4px;color:var(--brand-navy);font-weight:600}
.row-actions{display:flex;gap:8px;flex-wrap:wrap}
.td-actions{width:200px}
.btn-ghost{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:600}
.btn-danger{padding:8px 12px;border-radius:8px;border:1px solid #fee2e2;background:#fee2e2;color:#ef4444;cursor:pointer;font-weight:600}
.success-message{margin-top:12px;padding:12px 16px;border-radius:12px;background:#e6f9f8;border:1px solid #0da5a0;display:none;align-items:center;gap:8px;font-weight:600}
</style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="brand-icon"><i class="fas fa-user-tie"></i></div>
      <div class="name">AgoraHora</div>
    </div>
    <button class="btn" id="voltar"><i class="fas fa-arrow-left"></i> Voltar</button>
  </div>
</header>

<main class="container">
  <div class="card">
    <h2><i class="fas fa-user-plus"></i> Cadastrar profissional</h2>
    <label for="nome">Nome</label>
    <input id="nome" placeholder="Ex.: João Silva" />
    <label for="especialidade">Especialidades (vírgula separa)</label>
    <input id="especialidade" placeholder="Ex.: Barba, Corte, Infantil" />
    <button class="btn" id="btn-salvar" style="margin-top:12px"><i class="fas fa-save"></i> Salvar</button>
    <div id="msg" class="success-message"><i class="fas fa-check-circle"></i> Profissional salvo com sucesso!</div>
  </div>

  <div class="card">
    <h2><i class="fas fa-users"></i> Profissionais</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Nome</th><th>Especialidades</th><th class="td-actions">Ações</th></tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="empty" colspan="3"><i class="fas fa-user-slash"></i> Sem profissionais cadastrados…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<script>
/*
  Versão sem nenhuma chamada para /api/usuario (singular).
  Usa apenas /api/usuarios/* e /api/profissionais/*.
*/

const API_BASE = window.API_BASE || "http://179.0.176.111:5000/api";

/* elementos */
const voltar = document.getElementById('voltar');
const btnSalvar = document.getElementById('btn-salvar');
const msg = document.getElementById('msg');
const tbody = document.getElementById('tbody');
const nomeInput = document.getElementById('nome');
const espInput = document.getElementById('especialidade');

voltar.onclick = () => {
  if (document.referrer && document.referrer !== location.href) history.back();
  else location.href = 'index.html';
};

/* fetch util com timeout */
async function fetchWithTimeout(resource, options = {}) {
  const { timeout = 12000 } = options;
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const res = await fetch(resource, { signal: controller.signal, ...options });
    clearTimeout(id);
    return res;
  } catch (err) {
    clearTimeout(id);
    throw err;
  }
}

/* monta URL (usa API_BASE quando for caminho relativo) e injeta token */
function buildUrl(path) {
  if (/^https?:\/\//i.test(path)) return path;
  return API_BASE.replace(/\/$/,'') + '/' + String(path).replace(/^\//,'');
}

/* GET JSON com tratamento de 401 e timeouts */
async function getJson(path, opts = {}) {
  const url = buildUrl(path);
  const token = localStorage.getItem('ah_token');
  const headers = Object.assign({ 'Accept': 'application/json' }, opts.headers || {});
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const res = await fetchWithTimeout(url, Object.assign({}, opts, { headers }));
  if (res.status === 401) {
    localStorage.removeItem('ah_token'); localStorage.removeItem('ah_estab'); location.href = 'login.html';
    throw new Error('Não autorizado');
  }
  const ct = res.headers.get('content-type') || '';
  const txt = await res.text();
  if (!res.ok) throw new Error(ct.includes('json') ? txt : txt || res.statusText);
  try { return ct.includes('application/json') ? JSON.parse(txt) : txt; } catch { return txt; }
}

/* POST/PUT/DELETE wrapper */
async function sendJson(method, path, body) {
  const url = buildUrl(path);
  const token = localStorage.getItem('ah_token');
  const headers = Object.assign({}, token ? { 'Authorization': 'Bearer ' + token } : {}, body ? { 'Content-Type':'application/json' } : {});
  const res = await fetchWithTimeout(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
  const txt = await res.text();
  const ct = res.headers.get('content-type') || '';
  if (res.status === 401) { localStorage.removeItem('ah_token'); location.href='login.html'; throw new Error('Não autorizado'); }
  if (!res.ok) throw new Error(ct.includes('json') ? txt : (txt || res.statusText));
  try { return ct.includes('application/json') ? JSON.parse(txt) : txt; } catch { return txt; }
}

/* obter estabelecimento do usuário logado usando rota existente -> /api/usuarios/me/estabelecimentos */
async function resolveEstabId() {
  const token = localStorage.getItem('ah_token');
  if (!token) return null;
  try {
    const arr = await getJson('/usuarios/me/estabelecimentos');
    const list = Array.isArray(arr) ? arr : (arr.data ?? arr);
    if (Array.isArray(list) && list.length) return list[0].estabelecimentoId ?? list[0].EstabelecimentoId ?? null;
  } catch(e) {
    // fallback para /usuarios/me se backend expor
    try {
      const me = await getJson('/usuarios/me');
      return me?.estabelecimentoId ?? me?.estabId ?? null;
    } catch {}
  }
  return null;
}

/* carregar profissionais do estabelecimento */
async function carregarProfissionais(estabId) {
  try {
    const r = await getJson(`/profissionais/${encodeURIComponent(estabId)}?page=1&pageSize=100`);
    const profs = Array.isArray(r) ? r : (r.data ?? r);
    if (!Array.isArray(profs) || !profs.length) {
      tbody.innerHTML = `<tr><td class="empty" colspan="3"><i class="fas fa-user-slash"></i> Nenhum profissional</td></tr>`;
      return [];
    }
    tbody.innerHTML = profs.map(p => {
      const id = p.id ?? p.Id ?? p.ID;
      const nome = p.nome ?? p.Nome ?? '';
      const list = p.especialidades ?? p.Especialidades;
      const esp = Array.isArray(list) && list.length ? list.map(x=>`<span class="tag">${escapeHtml(x)}</span>`).join('') : escapeHtml(p.especialidade ?? p.Especialidade ?? '—');
      return `<tr data-id="${id}">
        <td>${escapeHtml(nome)}</td>
        <td>${esp}</td>
        <td class="td-actions">
          <div class="row-actions">
            <button class="btn-ghost" data-action="edit" data-id="${id}"><i class="fas fa-edit"></i> Editar</button>
            <button class="btn-danger" data-action="delete" data-id="${id}"><i class="fas fa-trash"></i> Apagar</button>
          </div>
        </td>
      </tr>`;
    }).join('');
    return profs;
  } catch (err) {
    console.error('carregarProfissionais', err);
    tbody.innerHTML = `<tr><td class="empty" colspan="3">Erro ao carregar profissionais: ${escapeHtml(err.message || err)}</td></tr>`;
    return [];
  }
}

function escapeHtml(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* criar / editar / deletar */
async function criarProfissional(estabId, nome, espTxt) {
  return await sendJson('POST', '/profissionais', { EstabelecimentoId: estabId, Nome: nome, Especialidade: espTxt });
}
async function editarProfissional(id, nome, espTxt) {
  return await sendJson('PUT', `/profissionais/${encodeURIComponent(id)}`, { Nome: nome, Especialidade: espTxt });
}
async function atualizarEspecialidadesById(id, nomes) {
  return await sendJson('PUT', `/profissionais/id/${encodeURIComponent(id)}/especialidades`, { nomes });
}
async function deletarProfissional(id) {
  return await sendJson('DELETE', `/profissionais/${encodeURIComponent(id)}`);
}

/* eventos de linha (editar/salvar/cancelar/delete) */
tbody.addEventListener('click', async (ev) => {
  const btn = ev.target.closest('button');
  if (!btn) return;
  const action = btn.dataset.action;
  const id = btn.dataset.id;
  const tr = btn.closest('tr');
  if (!tr) return;

  try {
    if (action === 'edit') {
      const nomeCell = tr.children[0].textContent.trim();
      const espCell = Array.from(tr.children[1].querySelectorAll('.tag')).map(t => t.textContent.trim()).join(', ');
      tr.innerHTML = `
        <td><input id="edit-nome" value="${escapeHtml(nomeCell)}" /></td>
        <td><input id="edit-esp" value="${escapeHtml(espCell)}" placeholder="Separe por vírgulas" /></td>
        <td class="td-actions">
          <div class="row-actions">
            <button class="btn-ghost" data-action="save" data-id="${id}"><i class="fas fa-save"></i> Salvar</button>
            <button class="btn-ghost" data-action="cancel" data-id="${id}"><i class="fas fa-times"></i> Cancelar</button>
          </div>
        </td>`;
      tr.querySelector('#edit-nome').focus();
    } else if (action === 'cancel') {
      await init(); // recarrega
    } else if (action === 'save') {
      const newNome = tr.querySelector('#edit-nome').value.trim();
      const newEsp = tr.querySelector('#edit-esp').value.trim();
      if (!newNome) { alert('Nome obrigatório'); return; }
      await editarProfissional(id, newNome, newEsp);
      const nomes = (newEsp||'').split(',').map(s=>s.trim()).filter(Boolean);
      if (nomes.length) await atualizarEspecialidadesById(id, nomes);
      await init();
    } else if (action === 'delete') {
      if (!confirm('Confirmar exclusão do profissional?')) return;
      await deletarProfissional(id);
      await init();
    }
  } catch (err) {
    alert('Erro: ' + (err?.message || err));
    console.error(err);
  }
});

/* salvar novo */
btnSalvar.onclick = async () => {
  try {
    const nome = nomeInput.value.trim();
    const espTxt = espInput.value.trim();
    if (!nome) { alert('Informe o nome'); return; }
    let estab = Number(localStorage.getItem('ah_estab')) || null;
    if (!estab) estab = await resolveEstabId();
    if (!estab) { alert('Estabelecimento não definido. Faça login novamente.'); localStorage.removeItem('ah_token'); location.href='login.html'; return; }
    const created = await criarProfissional(estab, nome, espTxt);
    const id = created?.data?.id ?? created?.data?.Id ?? created?.id ?? created?.Id;
    const nomes = (espTxt||'').split(',').map(s=>s.trim()).filter(Boolean);
    if (id && nomes.length) await atualizarEspecialidadesById(id, nomes);
    nomeInput.value=''; espInput.value='';
    msg.style.display='flex'; setTimeout(()=>msg.style.display='none',1500);
    await init();
  } catch (err) {
    alert('Erro ao salvar: ' + (err?.message || err)); console.error(err);
  }
};

/* init: garante token e carrega profissionais do estab correto */
async function init() {
  try {
    const token = localStorage.getItem('ah_token');
    if (!token) { location.href='login.html'; return; }
    let estab = Number(localStorage.getItem('ah_estab')) || null;
    if (!estab) estab = await resolveEstabId();
    if (!estab) estab = Number(localStorage.getItem('ah_estabelecimentoId')) || null;
    if (!estab) { alert('Estabelecimento não definido. Faça login novamente.'); localStorage.removeItem('ah_token'); location.href='login.html'; return; }
    await carregarProfissionais(estab);
  } catch (err) {
    tbody.innerHTML = `<tr><td class="empty" colspan="3">Falha na inicialização: ${escapeHtml(err.message || err)}</td></tr>`;
    console.error('init error', err);
  }
}

/* start */
init();
</script>
</body>
</html>
